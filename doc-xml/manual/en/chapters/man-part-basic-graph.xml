<?xml version="1.0" encoding="UTF-8"?>
<?oxygen RNGSchema="http://www.oasis-open.org/docbook/xml/5.0/rng/docbookxi.rng" type="xml"?>
<part
    version="5.0"
    xmlns="http://docbook.org/ns/docbook"
    xmlns:xlink="http://www.w3.org/1999/xlink"
    xmlns:xi="http://www.w3.org/2001/XInclude">
    <title>Basic graph creation</title>
    <partintro>
        <para>The goal of this part is to introduce some basic concepts that must be known when
            creating graphs with the JpGraph library. It will also serve as a gentle introduction on
            how to structure a basic graph script. </para>
        <para>The challenge of writing a good manual is that it is sometimes necessary to use
            concepts that might not have been fully explained in order to clarify some even more
            basic concept. So if there are parts that you do not fully understand do not despair.
            The remainder of the manual will explain a lot more of the details. </para>
    </partintro>
    <chapter>
        <title>Your first graph script</title>
        <formalpara>
            <title>What you will learn in this chapter</title>
            <para>This chapter will illustrate how a basic line and bar graph can be created and it
                will also show how input data should be prepared so it can be read and used by the
                library.</para>
        </formalpara>
        <sect1>
            <title>Some words of caution</title>
            <para>In order to quickly show a very first example we will create both a basic line
                graph and a basic bar graph that depicts the number of sun spots (a.k.a. solar
                flares) during the 19th century. The goal of this example is not to show every
                possible configuration and parameter supported by the library but rather show how
                simple it is to create a basic graph.</para>
            <para>In the sections following this one we will describe more in details the
                idiosyncrasies about dynamic graph generation and JpGraph so even if you don't fully
                understand all the detail it will give a flavor of what is to come. As with all
                complex libraries one has to start somewhere and sometimes accept some practices
                without yet fully understand them. However, the goal of this manual is that after
                reading it through you will fully understand every single detail shown in this
                script.</para>
            <para>So, without further due, let's start.</para>
        </sect1>
        <sect1
            xml:id="sec1.graphing-sun-spots">
            <title>Graphing the number of sun spots during the 19th Century</title>
            <sect2>
                <title>The historic data</title>
                <para>It is a well known fact that sun spots have a certain pattern and regularity.
                    The cause of these regular patterns are not currently fully understood (even
                    though investigation into this phenomenon has been made since beginning of the
                    17:th century). The fact that solar storms affects the earth in terms of
                    interference with radio traffic and other sensitive electronic devices makes it
                    very interesting to keep careful records of the suns activities.</para>
                <para>For this reason the data of solar storm is readily available and makes an
                    interesting first example. The data used here is taken from SIDC (The Solar
                    Influences Data Analysis Center) in Belgium (<uri
                        xlink:href="http://sidc.oma.be/sunspot-data/SIDCpub.php">http://sidc.oma.be/sunspot-data/SIDCpub.php</uri>).
                    In this example we will use the summary historical data that shows the total
                    number of sun spots per year since 1700.. </para>
            </sect2>
            <sect2
                xml:id="sec.preparing-sunspots-data">
                <title>Preparing the data</title>
                <para>The first step is to get the data into our PHP script which makes for a first
                    good discussion since all graphs needs to get data from some source. The library
                    itself is agnostic in regards to from where the data is collected and only needs
                    (and requires) data stored in a PHP array of numbers (integers or floats). </para>
                <para>In principle the data to be plotted in the graph can come from :</para>
                <para>
                    <orderedlist>
                        <listitem>
                            <para>Hard-coded data in the script. This is the least flexible and can
                                only really be recommended for examples and really static
                                data.</para>
                        </listitem>
                        <listitem>
                            <para>Data stored in plain text files. (This is what we will use in this
                                example.)</para>
                        </listitem>
                        <listitem>
                            <para>Data stored in binary format in flat files. </para>
                        </listitem>
                        <listitem>
                            <para>Data stored in a database</para>
                        </listitem>
                        <listitem>
                            <para>Data sent to the script via URI parameter passing (either GET or
                                POST HTTP constructs can be used).</para>
                        </listitem>
                    </orderedlist>
                </para>
                <para>What is common among all these methods is that the creator of the script has
                    to read the data into one (or several) data arrays that can be used by the
                    library. For our example the data of sunspots are stored in a plain text file in
                    two columns, one column for the year (with a ".5" added which indicates the
                    average of the year) and one column for the number of sunspots for the
                    corresponding year. As illustration the first 10 lines of data is shown in <xref
                        xlink:href="#fig.first-ten-sunspot"/>.</para>
                <para>
                    <figure
                        xml:id="fig.first-ten-sunspot">
                        <title>The first ten rows of data of sunspot activities from year
                            1700</title>
                        <programlisting>1700.5   5.0  
1701.5  11.0  
1702.5  16.0  
1703.5  23.0  
1704.5  36.0  
1705.5  58.0  
1706.5  29.0  
1707.5  20.0  
1708.5  10.0  
1709.5   8.0</programlisting>
                    </figure>
                </para>
                <para>From this data we need to create two arrays, one with the number of sunspots
                    and one with the corresponding years. If we assume that the data is stored in a
                    text file named "<filename>yearssn.txt</filename>" in the same directory as the
                    script file the function in <xref
                        xlink:href="#fig.getsunspots"/>will read the data into two arrays</para>
                <para>
                    <figure
                        xml:id="fig.getsunspots">
                        <title>Reading numeric tabulated sunspot data from a file</title>
                        <programlisting xml:id="pl.getsunspots">#!getsunspots.php#</programlisting>
                    </figure>
                </para>
                <para>In the function above we have deviated from the common practice of not
                    including even the most basic error handling in examples by adding an exception
                    in case the data file could not be read. This is to emphasize that graph scripts
                    which reads data from potentially disconnected sources must have real quality
                    error and exception handling. As this is the first example we will not discuss
                    the details of the error handling other than saying that the library provides
                    one exception class <code>JpGraphException</code> that is meant to be used by
                    clients to signal unrecoverable errors in the code. The full details on error
                    handling in the library is discussed in <xref
                        xlink:href="#chap.error-handling"/></para>
                <para>
                    <tip>
                        <para>In the library there is an auxiliary utility class
                                <code>ReadFileData</code> to help read data from text files. In this
                            class there are methods to read data from a file in either of the
                            following formats</para>
                        <para>
                            <itemizedlist>
                                <listitem>
                                    <para> CSV (Comma Separated Values) format.
                                            <code>ReadFileData::FromCSV()</code></para>
                                </listitem>
                                <listitem>
                                    <para>two column format (almost) as we did manually above with
                                            <code>ReadFileData::From2Col()</code></para>
                                </listitem>
                                <listitem>
                                    <para>one column format
                                        <code>ReadFileData::From1Col()</code></para>
                                </listitem>
                            </itemizedlist>
                        </para>
                    </tip>
                </para>
                <para>Armed with the data in the two arrays <code>$year</code> and
                        <code>$ydata</code> we will now plot the data in a basic line graph with
                    some variations and then show the data in a bar graph.</para>
            </sect2>
            <sect2>
                <title>A basic line graph</title>
                <para>As the very first start we will create a line graph which shows sun spots as a
                    line graph. To keep the code focused on the graph we do not include the previous
                    function to read the data again in the code snippet shown below. Before we get
                    into the code we start by briefly discuss how your script can include the
                    necessary library files.</para>
                <para>All graph scripts must include at least two files,
                        <filename>jpgraph.php</filename> and some plot module. If we want to create
                    a line plot we must include <filename>jpgraph_line.php</filename>. Slightly
                    depending on the server setup and what paths are defined for PHP include files
                    (as discussed in <xref
                        xlink:href="#sec2.adjusting-php-include-path"/>) the include paths for the
                    library might look a bit different. However, we recommend that you install the
                    library files so they can be accessed, for example using,
                        <code>require_once('jpgraph/jpgraph.php')</code> (since this is what is
                    assumed by the library examples). Furthermore, we would recommend that the
                        <code>require_once()</code> construct is used to avoid including the same
                    file multiple times.</para>
                <para>
                    <programlisting>#!getsunspots2.php#</programlisting>
                </para>
                <para>Before we explain this code in some more detail it is a good idea to visualize
                    what we get when we execute this as script. The result of running this script is
                    shown in <xref
                        xlink:href="#fig.sunspotsex1"/></para>
                <para>
                    <programlisting>#=sunspotsex1|Line plot showing the number of sun spots since 1700#</programlisting>
                </para>
                <para>
                    <tip>
                        <para>You can always click on the filename in the title of a figure to view
                            the complete source code.</para>
                    </tip>
                </para>
                <para>Let us now walk through this code in some details.</para>
                <para>
                    <variablelist>
                        <varlistentry>
                            <term>Line 1-12</term>
                            <listitem>
                                <para>The size of the graph must always be specified so the first
                                    thing to do is to create a new graph object and set the width
                                    and height of the overall graph. All graph scripts will need to
                                    create at least one instance of the <code>Graph()</code> class.
                                    By convention in all our scripts we will name the created
                                    instance of the Graph class "<code>$graph</code>"..</para>
                                <para>The second thing that all graph scripts must specify is what
                                    kind of scales should be used. The library supports linear,
                                    integer, logarithmic, text and date scales. Since we know that
                                    our data consist of only integers we keep things simple and set
                                    both the X and the Y axis scale to be integers. The scale is
                                    specified as a string where the first half of the string
                                    denominates the X-axis scale and the second half denominates the
                                    Y-axis scale. So in our example we specify
                                    '<code>intint'</code>. With this explanation you can probably
                                    guess what '<code>intlog</code>' or '<code>linlog</code>' would
                                    do. Why not try it ?</para>
                            </listitem>
                        </varlistentry>
                        <varlistentry>
                            <term>Line 13-21</term>
                            <listitem>
                                <para>These lines sets some different text labels. By the naming
                                    convention used in the library you can probably guess what all
                                    those lines are doing. They set the overall graph title as well
                                    as the X- and Y-axis titles. To keep the example as lean as
                                    possible we use the default font and default size and color of
                                    the text strings.</para>
                            </listitem>
                        </varlistentry>
                        <varlistentry>
                            <term>Line 22-27</term>
                            <listitem>
                                <para>Each graph must have at least one plot (data series) that is
                                    added to the graph. In our case we wanted to create a line graph
                                    so we must create an instance of the class
                                        '<code>LinePlot</code>'. We create a new instance of this
                                    class and as a parameter use the data for the data series we
                                    want to create the line plot from, in our case the data array
                                    with the sun spot numbers.</para>
                            </listitem>
                        </varlistentry>
                        <varlistentry>
                            <term>Line 29</term>
                            <listitem>
                                <para>Understanding this single line is key to understanding dynamic
                                    graph generation with PHP. This line instructs the library to
                                    actually create the graph as an image, encode it in the chosen
                                    image format (e.g. png, jpg, gif, etc) and stream it back to the
                                    browser with the correct header identifying the data stream that
                                    the client receives as a valid image stream. When the client
                                    (most often a browser) calls the PHP script it will return data
                                    that will make the browser think it is receiving an image and
                                    not, as you might have done up to now from PHP scripts, text. </para>
                                <para>This is something that can be conceptually difficult to fully
                                    understand at first and that is why we are spending the entire
                                    next chapter <xref
                                        xlink:href="#chap.fund-dynamic-graph"/> on further exploring
                                    this. But for now please accept that this works and by calling
                                    the script above in your browser (it is available in the
                                        "<filename>Examples/</filename>" directory in the
                                    distribution as '<filename>sunspotsex1.php</filename>') you
                                    should get the exact same image as shown above in <xref
                                        xlink:href="#fig.sunspotsex1"/></para>
                            </listitem>
                        </varlistentry>
                    </variablelist>
                </para>
                <para>Let's now make a small variation of the above line graph. Let's make it a
                    filled line graph. instead. In order to do this we only have to add one single
                    line</para>
                <para>
                    <programlisting>#!sunspots-filled.php#</programlisting>
                </para>
                <para>The line above actually does two things. First it sets the basic color to
                    'orange' and then it modifies this color to be 50% opaque (0.5) which makes the
                    grid line shine through the fill color to some extent. The whole color handling
                    in the library is further describe both in <xref
                        xlink:href="#app.named-colors"/> as well as in <xref
                        xlink:href="#chap.color-handling"/>. The result of adding the line above is
                    shown in <xref
                        xlink:href="#fig.sunspotsex2"/></para>
                <para>
                    <programlisting>#=sunspotsex2|Displaying sun spots with a semi filled line graph#</programlisting>
                </para>
                <sect3>
                    <title>Adding tick labels to the X-axis</title>
                    <para>
                        <note>
                            <para>This section can be skipped at first reading since it contains
                                some slightly more advanced material. The reason why we have
                                included this section already now is that some of the issues
                                discussed here is an often repeated question among newcomers to the
                                library.</para>
                        </note>
                    </para>
                    <para>There is one bit of the available data that we haven't used yet and that
                        is the actual years. In the example above we can only see the count from
                        1700. (If we just want to look at the cyclic behaviour of the number of
                        sunspots this is fine since what year a specific number of sunspots appeared
                        is not relevant.) To make it easier to see what year corresponds to the
                        different sunspot numbers we must change the label on the X-axis scale to
                        show the years instead.</para>
                    <para>There is actually a couple of ways to do this. The easiest way is to just
                        add the labels we have (<code>$years</code>) on the X-axis and instruct the
                        library to use them instead. This is done with a call to the method
                            <code>SetTickLabels()</code> on the X-axis. This method call takes an
                        array as argument and uses the values in that array to populate all labels
                        on major tick marks. In order to make adequate room for the scale the
                        library automatically selects a suitable distance between each major tick
                        mark.</para>
                    <para>
                        <programlisting>#!sunspots-ticklabels.php#</programlisting>
                    </para>
                    <para>Adding this line to our previous graph will generate the graph shown in <xref
                            xlink:href="#fig.sunspotsex3"/></para>
                    <para>
                        <programlisting>#=sunspotsex3|Adding tick labels to the graph#</programlisting>
                    </para>
                    <para>However, there is a problem in the graph above. There are valid years on
                        the X-axis up to "2000" but then there is a single label "320". </para>
                    <para><emphasis
                            role="bold">What is going on here?</emphasis> Have we already discovered
                        a bug in the library? </para>
                    <para>No, not really. In the way we have setup the graph we have not provided
                        the library with enough labels. What has happened is that the integer scale
                        has chosen a suitable interval between each tick label to have enough space
                        to be able to show the labels. As can be seen from the figure the distance
                        chosen with this particular graph seems to be 20 years between each tick.
                        The way the default labeling works is that the end tick should be labelled
                        and hence be an even multiple of 20 years (in this case).</para>
                    <para>Since the library needs to have tick labels for all ticks it uses the
                        labels we supplied as far as they go (up to 2008) but since we didn't supply
                        data more than up to "2008" (in the <code>$year</code> array) the library
                        does what it can do and continues with the ordinal numbers where we failed
                        to provide enough labels.</para>
                    <para>Now, there are a some standard ways of correcting this abomination.</para>
                    <para>
                        <orderedlist>
                            <listitem>
                                <para>We can set a manual scale to make sure the scale ends exactly
                                    at 2008, i.e. the scale is exactly as long as our data. This is
                                    done by submitting the wanted scale min/max as additional
                                    argument in the <code>SetScale()</code> method. First the
                                    min/max for the Y-axis and then the min/max for the X-scale.
                                    Since we still want the Y-scale to be fully automatically
                                    determined we just put a "0" for both min and max on the Y-scale
                                    and specify 0 for the min x-value and then the exact number of
                                    sunspots we have measured as the maximum x-value.</para>
                                <para>
                                    <programlisting>#!sunspots-setscale.php#</programlisting>
                                </para>
                                <para>The result of this is shown in <xref
                                        xlink:href="#fig.sunspotsex4"/></para>
                                <para>
                                    <programlisting>#=sunspotsex4|Manually specifying the X scale to use just the supplied X values#</programlisting>
                                </para>
                            </listitem>
                            <listitem>
                                <para>An alternative way to get labels is to use a callback function
                                    to specify the labels. This works so that the library calls the
                                    user specified function and as argument passes the label (or the
                                    value of the label) that the library intends to put on a tick.
                                    The library will then use as the actual label whatever string
                                    value we return from our function. Since we know that the
                                    integer label 0 (the first tick) corresponds to the first value,
                                    i.e. "1700" we can simply take whatever label we get as
                                    argument, add "1700" and return that value. This way all labels
                                    will be properly named and even if the scale extends far beyond
                                    where we have data a sensible tick label will be shown.</para>
                                <para>A suitable callback function together with the method to
                                    instruct the library to use this callback would be</para>
                                <para>
                                    <programlisting>#!sunspots-labelcallback.php#</programlisting>
                                </para>
                                <para>and the result can be seen in <xref
                                        xlink:href="#fig.sunspotsex5"/></para>
                                <para>
                                    <programlisting>#=sunspotsex5|Using a callback to get correct values on the x axis#</programlisting>
                                </para>
                            </listitem>
                            <listitem>
                                <para>There is one more way to handle this issue which we will not
                                    cover in detail yet. This is to use a "text" scale. The
                                    "text"scale can be used when there is no need to show numeric
                                    values on the axis. A typical use for text scale would be to add
                                    labels to mark bar graphs. Of course a text can contain numeric
                                    strings that would make it visually indistinguishable from a
                                    "real" numeric value.</para>
                                <para>For text scales every label counts. So by default the library
                                    will assign a tick mark for each ordinal so that every label is
                                    used. In some cases this will just be two dense and then the
                                    tick and the labelling can be adjusted by calling the two
                                    methods <code>Axis::SetTextTickInterval()</code> and
                                        <code>Axis::SetTextLabelInterval()</code> to get to a wanted
                                    result. But for now we do not discuss this technique further
                                    here since it would bring too far.</para>
                            </listitem>
                        </orderedlist>
                    </para>
                </sect3>
            </sect2>
            <sect2>
                <title>A basic bar graph</title>
                <para>As a final illustration we will show how easy it is to change the plot type.
                    We will make a small modification of the previous script and display the sun
                    spots as a bar graph instead. In order to do this we take the code from <xref
                        xlink:href="#fig.sunspotsex2"/> and just change the creation of an instance
                    of the <code>LinePlot()</code> class to instead be an instance of the
                        <code>BarPlot()</code> class (to make the code more readable we also change
                    the name of the variable where we store the instance so it makes more sense). In
                    order to use this class we must also change the include statement so that the
                    bar module is included by adding the statement
                        <code>require_once('jpgraph/jpgraph_barplot.php')</code>. The changed code
                    would now look like this</para>
                <para>
                    <programlisting>#!sunspots-bar.php#</programlisting>
                </para>
                <para>and would result in the graph displayed in <xref
                        xlink:href="#fig.sunspotsex6"/></para>
                <para>
                    <programlisting>#=sunspotsex6|Changing the plot type to a bar plot instead#</programlisting>
                </para>
                <para>Since there are so many bars in small space we cannot see the individual bars
                    in the example in <xref
                        xlink:href="#fig.sunspotsex6"/>. So lets modify the script so that it only
                    shows the last 20 years of measurements so that we can see the individual bars.
                    To set this up there are two things we must do</para>
                <para>
                    <orderedlist>
                        <listitem>
                            <para>Change the scale ot a text scale since we want to make sure each
                                value is displayed. In addition the text scale actually changes one
                                more thing that we haven't mentioned. Using a text scale also
                                changes the alignment of the labels. For linear, integer,
                                logarithmic scales the labels are placed cantered below the tick
                                marks. For text labels they are instead place in between the tick
                                marks. This is the most common way of displaying bar graphs. This is
                                one more reason to think of text scales as a special scale mostly
                                suitable for bar graphs.</para>
                        </listitem>
                        <listitem>
                            <para>Add two lines of code to "chop off" the extra not wanted data in
                                the input data arrays.</para>
                        </listitem>
                    </orderedlist>
                </para>
                <para>The following code snippet shows the necessary modifications to the previous
                    script</para>
                <para>
                    <programlisting>#!sunspots-zoom.php#</programlisting>
                </para>
                <para>The final graph with the "zoomed" last 20 years can now be seen in</para>
                <para>
                    <programlisting>#=sunspotsex7|Sunspots zoomed to only show the last 20 years#</programlisting>
                </para>
                <para>Since the scale is larger we can now actually see the individual bars. By
                    default the library choses a light blue color to fill the interior. (Try to see
                    what happens if you add the method call
                        "<code>$barplot->SetFillColor('orange@0.5');</code>" just after the
                        "<code>$barplot</code>" variable has been assigned the new BarPlot
                    object.)</para>
            </sect2>
        </sect1>
    </chapter>
    <chapter
        xml:id="chap.fund-dynamic-graph">
        <title
            xml:id="chap_fundgraphics">Fundamentals of dynamic graph generation</title>
        <formalpara>
            <title>What you will learn in this chapter</title>
            <para>The purpose of this chapter is to put dynamic image generation in perspective and
                illustrate how HTML tags is used to call image generating scripts. Even if You are
                familiar with PHP it is strongly recommended to quickly browse through this chapter
                to make sure all concepts are known. If You fully understand and can explain the
                concept of MIME types, HTTP streams and why the "<emphasis
                    role="italic">Headers already sent error</emphasis>" error is a very common
                error when generating dynamic images with PHP it is probably safe to skip this
                chapter. Otherwise it might be wise to read through this chapter at least
                once.</para>
        </formalpara>
        <sect1
            xml:id="sec1.making-sense-of-HTTP-streams">
            <title>Making sense of HTTP streams and MIME types</title>
            <para>The following explanation is slightly simplified since a full description of the
                HTTP protocol would bring us a bit too far in this manual <orderedlist>
                    <listitem>
                        <para>A client (e.g. browser) requests data from the server by issuing a GET
                            (or possible a POST) command to the server. This is what happens when
                            you enter a URI in the address bar in the browser.</para>
                    </listitem>
                    <listitem>
                        <para>The server replies with a data stream (or an error if the requested
                            data wasn't available). This data stream is prepended with header (MIME
                            header) that tells the client (e.g. the browser) how to interpret the
                            data that follows. The most common type (and the default type if no
                            header is sent by a faulty server) is "<emphasis
                                role="bold">text/html</emphasis>" . This tells the client to
                            interpret the data as plain text with embedded HTML encoding. </para>
                        <para>When the data is to be interpreted as an image the header will instead
                            be one of the image headers, for example "<emphasis
                                role="bold">image/png</emphasis>" or "<emphasis
                                role="bold">image/jpeg</emphasis>". When the client receives this
                            header it will interpret all the following data as an image encoded in
                            the indicated format. </para>
                        <para>The important thing to keep in mind here is that each server reply
                            (initiated by a call from the client) can only have one and only one
                            MIME type. This is the key to further understanding the specific issues
                            with dynamic image generation. This explains why if a PHP script running
                            on the server sends a header first indicating that the following data it
                            sends should be interpreted by the client as an image it cannot also
                            include text since only one header can be used for one HTTP stream.
                        </para>
                    </listitem>
                </orderedlist></para>
            <para>What happens on a WEB-page with, for example, multiple <markup>&lt;img></markup>
                tags is that the browser issues a separate GET command for each of these images. So
                even though it can look like a fetching a single WEB-page can have different content
                each individual request to the server only have one single MIME type.</para>
        </sect1>
        <sect1>
            <title>What is an image?</title>
            <para>This might be strange question and you might already now the answer but having a
                true understanding will help. An image is simply a data stream of octets (bytes)
                specifying the exact color of a number of pixels. A typical image uses 32 bits to
                specify the color which means it can encode 2^32 different colors (Homework: How
                many gray levels is possible with 32 bits?). It would be perfectly possible to send
                this data stream as it is and indeed this is how the bitmap (BMP) format specifies
                the data. However, image data usually have a lot of redundancies that can be used to
                reduce the size of the data that needs to be transmitted to specify any given image.
                These compression formats are what is more commonly known as for example PNG, JPEG
                or GIF type of images. So it is actually more correct, in our view, to look upon
                these formats as different compression techniques rather than as true image formats. </para>
            <para>Contrary to popular belief it is not the suffix on a file per se that identifies a
                particular file as an image on a HTTP server but rather the mapping on the server
                that instructs the server to send back a particular header for a particular file
                type (as identified by the file suffix), the MIME type. This might not seem like an
                important distinction to make but keeping this in mind will help understanding how
                images are created with a PHP script.</para>
            <para>A normal PHP scripts sends back character data (or more likely HTML encoded
                character data) that is displayed by the browser. However it is nothing that stops
                the PHP script from sending back data that instead should be interpreted as an image
                assuming of course we know how to create such data.. </para>
            <para>How the client (i.e. the browser) should interpret the data sent is all controlled
                by the header that is sent before the data. So this now leads us to the idea that if
                our PHP script by some means constructs a valid image, compressed in a known format
                (say PNG), we can tell the client to interpret the data we send back as an image by
                just making sure we first send a header indicating that the data is an image.</para>
            <para>This could now lead us to the perhaps surprising but crucial insight that if we
                call our script that sends back valid image data "<filename>myimage.php</filename>"
                and open it in a browser, for example by opening the local URI
                    "<filename>http://localhost/myimage.php</filename>" for the browser this is no
                different then opening an image directly (for example
                    "<filename>http://localhost/myimage.png</filename>") </para>
            <para>The only difference is that in the first case (our PHP script) we create the
                header and data our self and in the second case the HTTP server looks up the file
                suffix (*.png) to find out what kind of header to send before reading the file and
                just passing on the data to the client.</para>
            <para>Armed with this new knowledge we realize that our PHP script <emphasis
                    role="italic">is</emphasis> an image for all practical purposes and intent from
                a clients point of view. So we could safely name our PHP script as a target for an
                    <markup>&lt;img></markup> tag. This gives us the final and most common way to
                call a graph script in a HTML page. </para>
            <para><code>&lt;img src="myimage.php"></code></para>
            <para>in exactly the same way as we would do with the old type of images. The "*.php"
                suffix is no problem since the client (e.g. the browser) don't care what the file
                ending is. It only cares about what header the server returns. If that header tells
                the browser that the data received should be interpreted as a PNG image it will do
                so regardless of the name of the source file on the server.</para>
        </sect1>
        <sect1>
            <title>Static vs dynamic images</title>
            <para>Having understood how we can generate images using a PHP script a new idea might
                be forming. There is nothing that says that we have to create the same image using
                the same data every time the graph script is called. We could for example randomly
                select a pre-stored image in a directory and every time we call (the same) graph
                script and new image is returned. Hence, with PHP scripts we can create dynamic
                images that generate different images depending on some yet to be specified
                parameters even though the script name stays the same. This is a new behaviour
                compared with our normal images. </para>
            <para>This could also lead to a new, and very real, problem which has to do with the
                local caching most browsers do in order to avoid re-fetching already fetched objects
                such as images. Normally a browser will check the time stamp on the file on the
                server and compare with the latest fetched version it has stored locally. If the
                browser sees that the file on the server is older than what it already has it will
                not re-fetch the file. </para>
            <para>Since a dynamic image is produced by a script and the script will stay the same
                even if the produced image is changing (due to new data) the browser might still
                think that the image has not changed since the script is the same and will not
                bother re-fetching it again. The exact behavior of the browser cache is usually
                adjustable by the end user and hence out of control for us who writes the script. A
                simple way to always force the client to re-fetch the dynamic image is described in <xref
                    xlink:href="#sec2.forcing-browser-update"/></para>
        </sect1>
        <sect1>
            <title>Dynamic images on the command line</title>
            <para>It is also possible to generate images directly using the command line version of
                PHP. This works the same way as the normal "through the browser" generation with the
                exception that no HTTP headers will be generated. Only the binary image data.</para>
            <para>This could be an effective way to make an efficient web-site by having some
                automatic creation of images at regular interval (perhaps using some kind of
                    <code>cron</code>-job) that are referenced as usual (with an
                    <markup>&lt;img></markup> tag) in the scripts. This will avoid having to
                re-generate the image every time a visitor hits the site.</para>
            <para>Please make sure that you run the command line version of PHP (cli). Using the CGI
                SAPI version of PHP will not work since then the HTTP headers will be generated. </para>
            <para>
                <note>
                    <para>If the CGI version is used the generation of headers may be suppressed by
                        adding the '-q' option. </para>
                </note>
            </para>
            <para>You can easily check the version installed by the command line</para>
            <para>
                <screen>$/> php --version</screen>
            </para>
            <para>this should give a reply with something like</para>
            <screen>PHP 4.3.8 (cli) (built: Aug 29 2004 18:48:13) Copyright (c) 1997-2004 The PHP Group Zend Engine v1.3.0, 
Copyright (c) 1998-2004 Zend Technologies</screen>
            <para>The important thing here is the <code>(cli)</code> marker. The JpGraph library
                check from what SAPI API it is invoked from and adjusts the header generation
                accordingly. </para>
            <para>If all the above requirements are met then images can be generated directly on the
                command line and stored in a suitable file. For example by </para>
            <para>
                <screen>$/> php myimage.php > image.png</screen>
            </para>
            <para>Please note that the file extension on the image file should match the format in
                which the image is generated.</para>
        </sect1>
        <sect1>
            <title>How to generate images with JpGraph library</title>
            <para>The two common steps for creating and using a Graph on your Web-page are</para>
            <para>
                <orderedlist>
                    <listitem>
                        <para>Create a script that constructs the graph, by getting the data and
                            specifying how the graph should look, the size, what colors to use, what
                            fonts to use and specifying other augmentations on the graph.</para>
                    </listitem>
                    <listitem>
                        <para>On the HTML page where the graph(s) should be displayed include add
                            one or more <markup>&lt;img></markup> tags which links to the PHP graphs
                            script. Of course it is perfectly possible to call the image script
                            directly in the browser to just display the generated image in the
                            browser. This way it is possible to include any number of graphs on the
                            Web-page.</para>
                    </listitem>
                </orderedlist>
            </para>
            <tip>
                <para>One further thing to keep in mind is that it is also possible to pass
                    arguments to the image script via the normal HTTP GET/POST arguments. </para>
                <para>For example </para>
                <para>
                    <screen>&lt;img src="showgraph.php?a=1&amp;b=2"> </screen>
                </para>
                <para>This could be used to control the appearance of the image or perhaps send data
                    to the image which will be displayed. Note that this is probably not the best
                    way to send large amount of data to plot. Instead the only practical way, for
                    large data sizes, is to get all the data in the image script directly, perhaps
                    from a DB. Another alternative for large amount of data to be sent to the image
                    script is by creating a POST request to the image script. This is further
                    discussed in ?? (Getting hold of the data to be displayed)</para>
            </tip>
            <sect2>
                <title>The standard steps of setting up a graph</title>
                <para>When it comes to the structure of your imaging script they will generally have
                    the following structure </para>
                <para>
                    <programlisting>&lt;?php
// ... Include necessary headers 
require_once 'jpgraph.php';
require_once '....';

// Create the graph instance
$graph = new Graph($width,$height, ...); 

// Specify what scale should be used in the graph
$graph->SetScale('...');

// ... code to construct the graph details and plot objects

// Add one or many plot objects to the graph
$graph->Add(..); 

// ... and send back the graph to the client
$graph->Stroke();
?></programlisting>
                </para>
                <para>JpGraph is completely Object oriented so all calls will be action on specific
                    instances of classes. One of the fundamental classes is the <code>Graph()</code>
                    class which represents the entire graph.</para>
                <para>After the creation of the <code>Graph()</code> object all the code lines to
                    construct the details of the graph are added. The final method called in an
                    image script will most likely be the <code>Graph::Stroke()</code> method. This
                    will send the constructed image back to the browser. A variation of this is used
                    if the graph are supposed to have image maps (CSIM). In that case the final
                    method will be <code>Graph::StrokeCSIM()</code></para>
                <para>
                    <caution>
                        <para>As discussed in <xref
                                xlink:href="#sec1.making-sense-of-HTTP-streams"/> no text can be
                            returned from an image script. Beware!</para>
                    </caution>
                </para>
                <para>In addition to this standard usage pattern you can also choose to:</para>
                <para>
                    <orderedlist>
                        <listitem>
                            <para>... send the graph directly to a file. This is done by specifying
                                a filename as parameter to the final <code>Stroke()</code> method
                                call. See <xref
                                    xlink:href="#sec2.writing-miage-to-file"/> for more detailed
                                information.</para>
                        </listitem>
                        <listitem>
                            <para>... access the GD image handler for further image processing (also
                                needed to include the image in an PDF file, see <xref
                                    xlink:href="#app.faq"/>)</para>
                        </listitem>
                        <listitem>
                            <para>... make use of the built-in cache system to send back a
                                previously generated image. The cache system, which lessens the
                                burden of the PHP server, works by avoiding running all the code
                                that follows the initial <code>Graph()</code> call by checking if
                                the image has already been created and in that case directly send
                                back the previously created (and stored in a file) image file to the
                                browser. The filename used for the image can be either manually
                                selected or automatically created based on the script name. In
                                addition it is also possible to specify a timeout value in the
                                initial call to the Graph() constructor to indicate how long the
                                image in the cache directory should be considered valid before a new
                                image is generated. A full description of the JpGraph cache system
                                is available in <xref
                                    xlink:href="#sec.efficient-graph-generation"/>.</para>
                            <para>
                                <note>
                                    <para>The cache system by default is disabled and must be
                                        enabled by setting the proper define in the file
                                            "j<filename>pg-config.inc</filename>"</para>
                                </note>
                            </para>
                        </listitem>
                        <listitem>
                            <para>... combine several graphs in the same image using the
                                    <code>MGraph()</code> class (Multi-Graph). This is an advanced
                                technique described in ??.</para>
                        </listitem>
                    </orderedlist>
                </para>
            </sect2>
            <sect2>
                <title>Choosing the image compression format for JpGraph</title>
                <para>By default JpGraph automatically chooses the image format to use in the order
                    PNG, JPEG and GIF. The exact format depends on what is available on the system
                    the library is installed on. There are two ways you can influence the way the
                    graphic format is chosen:</para>
                <para>
                    <orderedlist>
                        <listitem>
                            <para>Change the default graphic format by changing the DEFINE (in
                                    <filename>jpg-config.inc.php</filename>)</para>
                            <para><code>DEFINE('DEFAULT_GFORMAT','auto')</code></para>
                            <para>For example; if you by default want all your images to be
                                generated with JPG encodation the define should be changed to </para>
                            <para><code>DEFINE('DEFAULT_GFORMAT','jpg')</code></para>
                        </listitem>
                        <listitem>
                            <para>By dynamically (in your script) select the wanted compression
                                format with a call to</para>
                            <para><code>Image::SetImgFormat()</code></para>
                            <para>For example; if you want your image to use the JPEG format </para>
                            <para>
                                <code>$graph->img->SetImgFormat('jpeg')</code></para>
                            <para> (The above line assume that you have called your variable that
                                holds the instantiated <code>Graph()</code> object
                                    "<code>$graph</code>"</para>
                        </listitem>
                    </orderedlist>
                </para>
            </sect2>
            <sect2>
                <title>Sending back the image to the browser</title>
                <para>The very last statement in almost all graph scripts is the line</para>
                <para>
                    <screen>$graph->Stroke();</screen>
                </para>
                <para>
                    <note>
                        <para>Actually there are some valid exceptions to this when you do some more
                            advanced graph generation involving caching together with the CSIM
                            functionality.</para>
                    </note>
                </para>
                <para>This line starts the actual graph creation. All method calls up to this stage
                    has just been to set the scene for the library and specify all necessary
                    parameters. It is first when you make the call to the <code>Stroke()</code>
                    method the library actually starts to build the image. Assuming there are no
                    errors detected when the image is generated the library will now take the
                    following steps in principle:</para>
                <para>
                    <orderedlist>
                        <listitem>
                            <para>Start building the image in memory. This is done by analyzing the
                                specified parameters and making use of the supplied data in order to
                                create the various plots that have been specified.</para>
                        </listitem>
                        <listitem>
                            <para>Check what headers are needed, i.e. what image compression are
                                used for the graph, and send that header back to the client.</para>
                            <para>The library also have to check how the library was called since if
                                it was called from the command line no MIME headers should be sent
                                back at all, just the raw image data. Running the command line
                                version of PHP will allow you to dynamically create images without
                                using a HTTP server.</para>
                        </listitem>
                        <listitem>
                            <para>Send the actual image data representing the built up image back to
                                the client</para>
                        </listitem>
                    </orderedlist>
                </para>
                <warning>
                    <title>The dreaded: Headers has already been sent error</title>
                    <para>This is an error that everyone, and we really mean everyone, will see one
                        time or the other when producing dynamic images with PHP.</para>
                    <para>First, this is not a problem with JpGraph per se. What has happened is
                        that your PHP script which produces the image has already returned some data
                        to the client before the image header has been sent. </para>
                    <para>This is most often caused by one or more spaces before the first
                            "<code>&lt;?php</code>" statement. What happens is that the server
                        normally sends back all data it finds in the files it reads. Since the
                        server no sees a space, a perfectly valid character, it will send that data
                        back to the client. However, before it does that it will automatically
                        generate a header. Since it has seen a normal character data it will
                        generate a header telling the client to expect a data stream of
                        characters.</para>
                    <para>When later JpGraph tries to send its image header the server will detect
                        that a header has already been sent and since each HTTP data stream can only
                        have one type (and hence only one header) it will generate an error message
                        which is sent back to the client.</para>
                    <para>To correct this error check your files for any output (even a single
                        space) before the call to <code>Graph::Graph()</code> (or
                            <code>Graph::Stroke()</code>) If you are running on older version of a
                        Windows server this problem could also be caused by blank line at the end of
                        the files. On some older Windows versions together with PHP4 it might also
                        be called by a file ending in a newline (which all the JpGraph library files
                        does) Remove the newline so that the file ends just after the final
                            "<code>?></code>" Also remember that when you include external file
                        using <code>include/include_once</code> and so on PHP includes the whole
                        content of the file; this content of the file also includes any potential
                        carriage return/line feed or "blank" space before "<code>&lt;?php</code>"
                        and after "<code>?>"</code> These "dirty characters" will cause the problem
                        just described. </para>
                </warning>
            </sect2>
            <sect2
                xml:id="sec2.writing-miage-to-file">
                <title>Writing the image directly to a file</title>
                <para>In addition to just streaming the file back to the browser it is also possible
                    to write the file directly to a named file. The file name is given as an
                    argument to the Graph::Stroke() method. For example as </para>
                <para><code>$graph->Stroke('/tmp/myimage.png');</code></para>
                <para>There are three important things to note here<orderedlist>
                        <listitem>
                            <para>The PHP process must have write permission on the directory you
                                are trying to write the image file on. If you are running PHP
                                through your browser this means that the HTTP server process must
                                have write permission on that directory.</para>
                        </listitem>
                        <listitem>
                            <para>The file suffix (e.g. '<code>.png</code>') should match the image
                                compression type used.</para>
                        </listitem>
                        <listitem>
                            <para>If the image is streamed directly to a file and not back to the
                                browser the script can of course return ordinary text.</para>
                        </listitem>
                    </orderedlist></para>
                <tip>
                    <title>Writing the image to both a file and stream it back to the
                        browser</title>
                    <para>In this case you should instead use the method
                            <code>Graph::StrokeStore($aFileName)</code> which was introduced in
                        version 2.5 of the library. If you are on a previous version and for various
                        reasons cannot upgrade then you can use the following "trick" to achieve
                        this.</para>
                    <para>The idea is to use the <code>_IMG_HANDLER</code> option that forces the
                            <code>Graph::Stroke()</code> to just return the image handler and then
                        stop. We can then manually first send the image to the chosen file and then
                        stream it back to the browser using some internal methods in the library.
                        The following code snippet shows how this is done.
                        <programlisting>#!storestroke_snippet.php#</programlisting></para>
                </tip>
            </sect2>
            <sect2>
                <title>Alternatives to streaming or storing the image</title>
                <para>There are also two predefined filenames which have special meaning when
                    supplied as argument ot the <code>Stoke()</code> method.</para>
                <para>
                    <variablelist>
                        <varlistentry>
                            <term><code>_IMG_AUTO</code></term>
                            <listitem>
                                <para>This will create a file in the same directory as the script
                                    with the same name as the script but with the correct image
                                    extension. </para>
                            </listitem>
                        </varlistentry>
                        <varlistentry>
                            <term><code>_IMG_HANDLER</code></term>
                            <listitem>
                                <para>Specifying this filename will not create a an image to file
                                    nor stream it back to the browser. Instead it will instruct the
                                        <code>Stroke()</code> method to just return the handle for
                                    the GD image. This is useful if you later want to manipulate the
                                    image in ways that are not yet supported by JpGraph. For example
                                    include the image in a dynamically generated PDF file. See <xref
                                        xlink:href="#app.faq"/> for a detailed example how to
                                    include an image in a PDF generated with the "fpdf"
                                    library.</para>
                            </listitem>
                        </varlistentry>
                    </variablelist>
                </para>
            </sect2>
            <sect2
                xml:id="sec2.forcing-browser-update">
                <title>Forcing the browser to update your graph</title>
                <para>Some browser may not send back a request to the HTTP server unless the user
                    presses "Refresh" (F5 - in most browsers). This can lead to problems that the
                    user is seeing old data since the file stamp of the script might not change but
                    the data the script is using to create the image/graph is. A simple trick is to
                    add a dummy time argument which is not used in the script. </para>
                <para>For example </para>
                <para><code>&lt;img src="myimagescript.php?dummy=\'.now()."></code>
                </para>
                <para>Since the dummy argument will be a new number whenever the browser checks it
                    the browser understands that it must re-fetch the script and force the image to
                    be reloaded and redisplayed.</para>
                <para>It is also important to be aware of any internal caching the browser might do.
                    The general problem with dynamically generated images is that the image
                    generating script (file) remains the same. This makes the browser believe that
                    the data hasn\'t changed (since the script is the same) and if the browser
                    already has issued a previous GET request and has the data cached it will not
                    send a new GET if the time stamp on the file is the same since it then believes
                    it should and can use the old browser cached version.</para>
            </sect2>
            <sect2>
                <title>Printing the generated image</title>
                <para>Some browsers, most notable IE (&lt; v7) can have issues printing a dynamic
                    image. This is because the designers of IE assumed that all images are
                    traditional images that are available as static image files. Not that they could
                    be dynamically generated. This unfortunately have some implications.</para>
                <para>
                    <orderedlist>
                        <listitem>
                            <para>IE will often (always?) re-fetch the page when preparing to print.
                                This means that a new image will be generated and is perhaps very
                                different from what the user thinks he is printing (if the data is
                                changing rapidly).</para>
                        </listitem>
                        <listitem>
                            <para>Some older versions of IE simply refuses to print dynamic images
                                if they are not available as a static "*.png", "*.jpg" etc. file.
                                The only known workaround is to make sure to use static
                                images.</para>
                        </listitem>
                    </orderedlist>
                </para>
                <para>There is one final reported problem to be aware of. Normally most browsers
                    will support "right-clicking" on an image to download the image locally.
                    However, some older versions of IE will become very confused when dynamic images
                    are used. This could manifest itself as that the file type is not the wanted,
                    for example, trying to download a "*.png" image could cause the file to be saved
                    as a "*.bmp" file instead. </para>
                <para>Newer versions of IE seems to be able to handle dynamic images much
                    better.</para>
                <para>It should also be mentioned that some older versions of FireFox (&lt; v3)
                    could in some circumstances fetch a dynamic image twice causing unnecessary load
                    on the server (See <uri
                        xlink:href="https://bugzilla.mozilla.org/show_bug.cgi?id=331126">FireFox
                        Bugzilla</uri>). However, there are no known issues with dynamic images in
                    current versions of FireFox and IE (i.e. IE v8).</para>
            </sect2>
        </sect1>
        <sect1
            xml:id="sec.efficient-graph-generation">
            <title>Efficient graph generation using the built-in cache subsystem</title>
            <para>The full explanation of how to use the JpGraph cache system is deferred to <xref
                    xlink:href="#chap.using-cache"/> so this early section is just to explain the
                principles and why you probably want to read through the full chapter later
                on.</para>
            <para>The core problem is that generating images can require a lot of CPU time. If we
                combine this with the interpreted nature of PHP we can get a potential lethal
                performance mixture. For example, if a web page uses one dynamically generated graph
                and at its peak the site has 50 hits per second this means that the PHP graph script
                also has to be called 50 times a second. On a high end server a typical graph takes
                in the range of 0.02s up to 0.2s (and some complex graph, for example an
                anti-aliased Contour-plot, can take up to 1s) to generate using a plain
                non-accelerated installation (see more on supported PHP Accelerators in <xref
                    xlink:href="#chap.php-accelerator"/>).</para>
            <para>If we furthermore makes the realistic assumption that the site needs to run some
                database services and generate other content as well the graph script itself might
                not be allowed to use more than 50% of the available CPU bandwidth. It is now easy
                to see that we are in trouble.</para>
            <para>Continuing with the example. Assuming our graph is medium complex and takes a
                whole 0.04s to generate. This means that if the server does not do anything more
                than just creating images then we can crank out 1/0.04 or 25 graphs per second per
                core at maximum. If we then take the 50% load into account it means that we could
                only be allowed to generate ~12 graphs per second per core and remember that this
                was on a high end server. If we now have more than 12 hits per second or have a more
                average server with a less powerful CPU we are heading directly for a seriously
                under dimensioned server.</para>
            <para>If we assume we are running our server on a dual-core CPU this gives us an upper
                practical limit of 24 graphs per second per server.</para>
            <para>There are a couple of ways to counteract this problem but none is a 100%
                solution.</para>
            <para><orderedlist>
                    <listitem>
                        <para>Introduce load balancing among several servers. This is a common way
                            to dynamically adjust to varying loads but without some serious
                            investments into a server farm it is still possible to overload the
                            system.</para>
                    </listitem>
                    <listitem>
                        <para>Reduce the complexity of the graphs. However there is still a limit,
                            even very simple and basic graphs takes in the order of 0.02s on a high
                            end server due partly to the cost PHP parsing of all the library files.
                            This means that the upper limit is still valid.</para>
                    </listitem>
                    <listitem>
                        <para>Make use of a PHP accelerator. If you are running a professional
                            server this is a must. We would go so far as to say that running a
                            professional PHP server without using any of the available PHP
                            accelerators borders on gross misconduct on the behalf of the
                            information architect that did the logical server design. Using a PHP
                            accelerator we can normally expect to get an almost 100% improvement.
                            Taking the previous example as a case we can probably expect an upper
                            limit of ~24 graphs per second per core instead of the normal
                            ~12.</para>
                    </listitem>
                    <listitem>
                        <para>Make use of the built in cache system in JpGraph. This system if set
                            up correctly will avoid the problem by not having to generate the same
                            (or almost the same) image over and over again. The core idea of the
                            system is the observation that the majority of the data presented on a
                            WEB page is changing only very slowly compared with the hits a server
                            gets. </para>
                        <para>For example, if a server has a graphical overview of defects by
                            showing inflow/outflow there is probably a good case to state that the
                            data change sufficiently slowly that it is probably not necessary to
                            re-generate the graph more than 6 times per day (or perhaps even just
                            once per day).</para>
                        <para>The JpGraph cache system allows you to do just that. What you do is
                            specify a timeout. When the server calls the graph script the script
                            first checks if a previous image has been generated. If that is the case
                            it then checks how old the image is and if it is newer than the timeout
                            limit then the existing image is sent back. It is just in the case that
                            there isn't already any image (the script has never been run) or that
                            the existing image is too old (older than the specified timeout limit)
                            that the image gets generated again.</para>
                        <para>You could of course do all of this manually but the library has built
                            in support for this that will allow you to use the system without
                            changing a single line in your existing scripts. It is all taken care of
                            in the background.</para>
                    </listitem>
                </orderedlist>For a production server the recommended setup is to use a combination
                of load balancing, a suitable PHP accelerator and enabling the JpGraph cache
                system.</para>
        </sect1>
    </chapter>
    <chapter
        xml:id="chap.error-handling">
        <title>Error handling</title>
        <sect1>
            <title>The problem with error messages and images</title>
            <para>Why a whole chapter on error handling? The answer is that error handling with
                scripts that produces images requires a slightly different approach than normal
                error messages. In order to appreciate the added complexity one needs to consider
                how a graph script is called. Usually a graph script is called from an
                    <markup>&lt;img></markup> tag. This means that the client (e.g. the browser)
                expect image data to be sent from the script. If we instead send a textual error
                message the browser will not be able to display anything. It was expecting a stream
                with image data and the data received was a representation of an error message which
                of course cannot be interpreted as an image.</para>
            <para>To handle this problem the error messages produced by the library are normally
                generated as an image. A typical error message can be seen in <xref
                    xlink:href="#fig.errmsg-ex1"/></para>
            <figure
                xml:id="fig.errmsg-ex1">
                <title>Typical image error message</title>
                <mediaobject>
                    <imageobject>
                        <imagedata
                            scale="70"
                            fileref="images/errmsg-ex1.png"/>
                    </imageobject>
                </mediaobject>
            </figure>
            <para>There is one exception to this rule and that is in the case of the "Headed already
                sent" error message. This means that the client has already received an header and
                with probability bordering on certainty this is a text header. Hence in this case it
                does not make sense to send an image so this, and only this, error message is sent
                as a normal "text/html" type message. A typical example how this message is shown in
                the browser can be seen in <xref
                    xlink:href="#fig.errmsg-header-sent"/></para>
            <figure
                xml:id="fig.errmsg-header-sent">
                <title>The "Header already sent error message"</title>
                <mediaobject>
                    <imageobject><imagedata
                            scale="70"
                            fileref="images/errmsg-headersent.png"/></imageobject>
                </mediaobject>
            </figure>
            <para>When you get this error (and we mean when - not if) take a very close look at the
                text in red. This will tell you in what file and what line the erroneous output
                started. In most cases this will be an innocent looking space or a tab character. It
                could also be caused by multiple newlines at the end of a file. Since by definition
                these mistakes can be hard to spot since spaces and tabs are not normally visible in
                an editor so take care! </para>
            <sect2>
                <title>Catching errors in other parts of the system while creating images</title>
                <para>The problem described in the previous section will also apply to error
                    messages that are generated directly from PHP as well. In order to be able to
                    see any potential error messages during development it is possible to instruct
                    the library to intercept PHP error messages and convert them to image messages
                    instead. This is controlled by the two defines
                        <code>INSTALL_PHP_ERR_HANDLER</code> and <code>CATCH_PHPERR</code> define in
                        <filename>jpg-config.inc.php</filename>
                </para>
                <para>
                    <variablelist>
                        <varlistentry>
                            <term><code>INSTALL_PHP_ERR_HANDLER</code></term>
                            <listitem>
                                <para>Setting this define to true will make the library install a
                                    custom error handler which will catch all PHP error messages and
                                    convert them into an image like what can be seen in <xref
                                        xlink:href="#fig.errmsg-ex1"/>. </para>
                                <para>By default this is disabled.</para>
                            </listitem>
                        </varlistentry>
                        <varlistentry>
                            <term><code>CATCH_PHPERR</code></term>
                            <listitem>
                                <para>This defines control whether the library shall check for any
                                    generated error message that are stored in the global PHP
                                    pre-defined variable <code>php_errmsg</code>. This can be very
                                    useful during development if an error has occurred prior to
                                    calling the graph script. This error will then be displayed as
                                    an image.</para>
                                <para>By default this is enabled.</para>
                            </listitem>
                        </varlistentry>
                    </variablelist>
                </para>
            </sect2>
        </sect1>
        <sect1>
            <title>Available error messages</title>
            <para>All error messages that can be generated by the library are listed in <xref
                    xlink:href="#app.err-msg"/></para>
            <sect2
                xml:id="sec2.localizing-errmsg">
                <title>Localizing error messages</title>
                <para>The library includes two (actually two and one pseudo) localizations of the
                    error messages. As of version 2.5 the library supports English and German error
                    messages. The choice of which localization of error messages that should be used
                    can be done in two ways; either by specifying a global define in
                    jpg-config.inc.php or</para>
                <para>As of version 2.5 there are three localization options</para>
                <para><orderedlist>
                        <listitem>
                            <para>English error messages ("en")</para>
                        </listitem>
                        <listitem>
                            <para>German error messages ("de")</para>
                        </listitem>
                        <listitem>
                            <para>Production error messages. This is not really a localization but a
                                different set of error messages which does not give detailed error
                                messages but a generic message suitable for a production server
                                where the end user is not helped by detailed graph script errors.
                                Instead a generic message is shown together with an error code that
                                corresponds to the detailed error. ("prod")</para>
                        </listitem>
                    </orderedlist>In order to specify the error message localization the following
                    define in <filename>jpg-config.inc.php</filename> must be set the </para>
                <para><code>define('DEFAULT_ERR_LOCALE','en');</code></para>
                <para>The possible (string) options are</para>
                <para><orderedlist>
                        <listitem>
                            <para>"en", English locale</para>
                        </listitem>
                        <listitem>
                            <para>"de", German locale</para>
                        </listitem>
                        <listitem>
                            <para>"prod", The production version of the error messages.</para>
                        </listitem>
                    </orderedlist>It is also possible to dynamically set the localization of error
                    messages by calling the static method
                        <code>JpGraphErr::SetErrLocale($aLocaleString)</code> .For example, in order
                    to dynamically change to German locale the following method call would be
                    used:</para>
                <para><code>JpGraphErr::SetErrLocale('de');</code></para>
                <para>As an example of the German locale the "<emphasis
                        role="italic">Header Already Sent</emphasis>" error message localized in
                    German are shown in <xref
                        xlink:href="#fig.errmsg-de-headers-sent"/></para>
                <figure
                    xml:id="fig.errmsg-de-headers-sent">
                    <title>The "Header already sent" error message using German locale</title>
                    <mediaobject>
                        <imageobject><imagedata
                                scale="70"
                                fileref="images/errmsg-headersent-de.png"/></imageobject>
                    </mediaobject>
                </figure>
                <note>
                    <para>There is one potential issue with specifying the locale dynamically. Since
                        the call to set the locale happens in the script at a certain point this
                        means that if the error occur before that point the locale change has not
                        yet happened and the default locale specified in
                            <filename>jpg-config.inc.php</filename> will be used.</para>
                </note>
            </sect2>
            <sect2>
                <title>Error messages on a production server</title>
                <para>On a production server it is common not to show detailed specific error
                    messages to the public which could potentially give a away security
                    vulnerabilities. For this purpose there is a "pseudo" locale of the error
                    messages. This is specified by setting the locale (as described above) to the
                    string "prod". If this is done a generic error message with an error code will
                    be shown instead. The custom support receiving information on this error can
                    then pass on the detailed error code to the development team for further
                    investigation. In <xref
                        xlink:href="#fig.pseudo-locale"/> the same error as is shown in <xref
                        xlink:href="#fig.errmsg-ex1"/> is displayed using the "prod" locale. As you
                    can see in this case only a more end-user appropriate message together with the
                    error code is displayed.</para>
                <figure
                    xml:id="fig.pseudo-locale">
                    <title>Using the production "pseudo" locale</title>
                    <mediaobject>
                        <imageobject><imagedata
                                scale="70"
                                fileref="images/errmsg-prod.png"/></imageobject>
                    </mediaobject>
                </figure>
                <para>The problem number corresponds to the error codes that are listed in <xref
                        xlink:href="#app.err-msg"/></para>
                <para>
                    <tip>
                        <para>It is possible to customize this "production" error message by
                            changing the actual text in the file
                                "<filename>lang/prod.inc.php</filename>"</para>
                    </tip>
                </para>
            </sect2>
        </sect1>
        <sect1>
            <title>Using PHP Exceptions</title>
            <para>Starting with version v2.5 the library now have full support for PHP5 style
                exceptions. The library provides an exception class named
                    <code>JpGraphException</code> which is slightly different compared with
                traditional exception classes in that this class can not only return an text string
                as error but also an image. This is necessary in order to handle the case where a
                script has an error and is called from within an <markup>&lt;img></markup> tag. The
                only data that can then be displayed in a browser is image data and hence it is
                necessary for the error to be formatted as an image.</para>
            <para>In addition to providing an exception class the library also installs its own
                default exception handler to properly display an image. This default exception
                handler will be automatically called whenever an "uncaught" exception would
                otherwise be generated. This means that it is strictly not necessary to use
                    "<code>try {} catch() {}</code>" blocks around the library scripts.</para>
            <para>When an exception is generated the default exception handler first validates that
                the exception is a proper descendant of <code>JpGraphException</code> and if so,
                generates the image by calling the <code>JpgraphException::Stroke()</code> method.
                If the exception is not a <code>JpGraphException</code> based exception then the
                handler re-raises the error. This means that in script that you create that is meant
                to be called from within an <markup>&lt;img></markup> tag all exception should be a
                derivate of <code>JpGraphException</code> in order to properly generate an error
                image.</para>
            <para>A typical example on how to raise an exception in your own code is shown in <xref
                    xlink:href="#ex.jpgraphexception1"/></para>
            <para>
                <example
                    xml:id="ex.jpgraphexception1">
                    <title>Throwing a JpGraph exception</title>
                    <programlisting>#!jpgraphexceptionex1.php#</programlisting>
                </example>
            </para>
            <para>In case you need to handle the exception in a "<code>try {} catch() {}</code>"
                block (perhaps in order to do necessary cleanup) it is important to remember to call
                the <code>Stroke()</code> method which will create and stream the error message back
                to the browser. An example of this is shown in <xref
                    xlink:href="#ex.jpgraphexception2"/></para>
            <para>
                <example
                    xml:id="ex.jpgraphexception2">
                    <title>Catching a JpGraph exception and sending it back as an image to the
                        client</title>
                    <programlisting>#!jpgraphexceptionex2.php#</programlisting>
                </example>
            </para>
            <para>
                <tip>
                    <para>Another typical augmentation of the exception handling might be to also
                        log an error to some logging server or plain log file. This should be done
                        before the call to <code>Stroke()</code> since that call will never
                        return.</para>
                </tip>
            </para>
            <para>An example of real life error handling with exception is shown in listing <xref
                    xlink:href="#sec.preparing-sunspots-data"/> in the introductory example with Sun
                spots.</para>
            <sect2>
                <title>Selecting between text and image based error handling</title>
                <para>By default an exception that occurs in the library will create an error image
                    as shown in the previous section. However there might be circumstance where a
                    text based error handling is preferred (usually when graph are created from the
                    command line). </para>
                <para>This could be accomplished in two ways. By catching the exception in the
                    script and handle it accordingly or we could slightly modify the default
                    behavior of the default exception handler in the library. How this is done will
                    now be described.</para>
                <para>In order to enable a text based error handler we just need to disable the
                    image based error handler. This is done with a call to the method</para>
                <para>
                    <itemizedlist>
                        <listitem>
                            <para><code>JpGraphError::SetImageFlag($aFlag)</code></para>
                        </listitem>
                    </itemizedlist>
                </para>
                <para>Since the error handling have global scope this is a static function which can
                    be called as the following example shows</para>
                <para>
                    <programlisting>JpGraphError::SetImageFlag(false); // Enable text based error handling</programlisting>
                </para>
                <para>Adding the line above to a graph script will cause any error to be printed to
                        <code>STDERR</code> when the script is called from the command line. This is
                    a very convenient way to show errors when command line constructions like</para>
                <para>
                    <screen>$> php mygraph.php > mygraph.png</screen>
                </para>
                <para>is used since writing the error to <code>STDOUT</code> will cause the error
                    message to be sent back to the console since the call above only redirected
                        <code>STDOUT</code> and not <code>STDERR</code>. </para>
                <para>When the script is called from PHP embedded in a HTTP server (e.g. Apache)
                    there is no concept of a <code>STDERR</code> and the error message will just be
                    sent back as normal text to the browser.</para>
            </sect2>
            <sect2>
                <title>Writing error message to a log file (or system logger)</title>
                <para>In addition to the option of having the error sent back as a string to the
                    client it can instead be written to a named log file. The log file name is
                    specified with a call to the (static) method</para>
                <para>
                    <itemizedlist>
                        <listitem>
                            <para><code>JpGraphError::SetLogFile($aFileName)</code></para>
                        </listitem>
                    </itemizedlist>
                </para>
                <para>The file needs to be writable by the PHP process. All error messages are
                    appended to the end of the file and each error message is prepended by the date
                    and time (in <uri
                        xlink:href="http://www.faqs.org/rfcs/rfc2822">RFC 2822</uri> formatted
                    date).</para>
                <para>If the filename is given as the string <code>'syslog'</code> then the error
                    message will be written to the default system logger instead. When a script is
                    run from, for example, Apache this is normally on Unix
                        '<filename>/var/log/apache2/error_log</filename>'</para>
            </sect2>
        </sect1>
        <sect1>
            <title>Adding a new locale</title>
            <para>All error messages are stored in an array with a specific index that cannot be
                changed. This index is used in the library to reference a specific error message. </para>
            <para>Since error messages can also have additional parameters the error messages also
                includes count that specifies how many arguments must be handled to enable some
                error checking when using the error message in the code (to make sure we have enough
                arguments).</para>
            <para>The arguments are formatted in the error text in the same way as parameters in the
                    <code>printf()</code> family of functions.</para>
            <para>To create a localized error resource file You should first copy the
                    "<filename>en.inc.php</filename>" to a temporary file, rename it according to
                the locale you are creating and then translate each error message according to the
                locale. The make sure that the file is stored under the
                    "<filename>jpgraph/lang/</filename>" catalogue and the new localized error
                messages can be used. </para>
            <para>For example. To create a French version of the error messages the
                    <filename>lang/en.inc.php</filename> should be copied to
                    <filename>lang/fr.inc.php</filename> and the error messages translated. The
                French locale can then be used by using the string "<code>fr</code>" as identified
                in <code>SettErrLocale()</code> as described above.</para>
        </sect1>
    </chapter>
    <chapter
        xml:id="chap.color-handling">
        <title>Color handling</title>
        <para>An important part of creating visually clear graphs is the use of appropriate colors.
            In order to simplify color handling JpGraph supports several ways to adjust and
            manipulate color both by value and by name. </para>
        <para>Almost all color setting methods (with basically only one exception) for all objects
            in the graph has one of two names</para>
        <para><itemizedlist>
                <listitem>
                    <para><code>SetColor()</code>, Sets the outline color or if the object only have
                        one color (e.g. a font) it sets this color</para>
                </listitem>
                <listitem>
                    <para><code>SetFillColor()</code>, Specifies the area fill color for objects
                        which has a concept of an area.</para>
                </listitem>
            </itemizedlist>Both variants of methods take one argument which identifies the color by
            one of the available color specification methods as described below.</para>
        <sect1>
            <title>Specifying colors by name</title>
            <para>There are a number of "standard colors" known by (more or less) illustrative
                names. A list of all color names that can be used as well as actual color can be
                found in <xref
                    xlink:href="#app.named-colors"/>. </para>
            <para>For example:</para>
            <para>
                <itemizedlist>
                    <listitem>
                        <para><code>SetColor('white');</code></para>
                    </listitem>
                    <listitem>
                        <para><code>SetFillColor('orange');</code></para>
                    </listitem>
                </itemizedlist>
            </para>
            <para>
                <tip>
                    <para>Always use single quotes for strings when you do not need variable
                        substitution since this is faster.</para>
                </tip>
            </para>
        </sect1>
        <sect1>
            <title>Specifying colors by RGB triples</title>
            <para>Using the named colors will of course be restricted to the colors known by the
                library. If some other colors are needed then they must be specified
                manually.</para>
            <para>The first variant uses the RGB values for the color, i.e. the Red, Green and Blue
                component of a color. Each component is specified as an integer in the range [0,255]
                and the triple is specified as an array.</para>
            <para>For example:</para>
            <para>
                <itemizedlist>
                    <listitem>
                        <para><code>SetColor( array(255,255,255));</code></para>
                    </listitem>
                    <listitem>
                        <para><code>SetColor( array(0xff,0xff,0xff));</code></para>
                    </listitem>
                    <listitem>
                        <para><code>SetFillColor( array(0x44,0x54,0xa4));</code></para>
                    </listitem>
                </itemizedlist>
            </para>
            <para>As usual a value of <code>array(0,0,0)</code> specifies black and a value of
                    <code>array(255,255,255)</code> specifies white.</para>
        </sect1>
        <sect1>
            <title>Using HTML color specifications</title>
            <para>The second variant is more a less a the same as the RGB triples but instead of an
                array the RGB triple is specified as a string with the hexadecimal RGB values. This
                is commonly known as the "HTML color specification" since this form often used when
                creating WEB pages (for example in CSS sheets).</para>
            <para>For example:</para>
            <para>
                <itemizedlist>
                    <listitem>
                        <para><code>SetColor('#333')</code>, note that this is a short form for
                                <code>SetColor('#333333')</code></para>
                    </listitem>
                    <listitem>
                        <para><code>SetColor('#12be7a')</code></para>
                    </listitem>
                    <listitem>
                        <para><code>SetFillColor('#99eff5')</code></para>
                    </listitem>
                </itemizedlist>
            </para>
        </sect1>
        <sect1>
            <title>Fine tuning the color</title>
            <sect2
                xml:id="sec2.alpha-channel">
                <title>Specifying the alpha channel (color transparency)</title>
                <para>Colors can also be made semi-transparent by specifying a transparency value
                    (or as it is also known an <emphasis
                        role="italic">alpha channel value</emphasis>). This will instruct the
                    library to mix the foreground color with a certain amount of the background
                    colors creating a "shine-through" effect.</para>
                <para>The alpha channel is specified as a real number in the range [0.0, 1.0] where
                    0.0 means no transparency and 1.0 means full transparency (i.e. only the
                    background color is shown). The transparency is added as a postfix to the color
                    specification separated by a '@' (at) character. It is often most used with area
                    fills (i.e. when using <code>SetFillColor()</code>)</para>
                <para>For example the following are valid alpha channel modifiers</para>
                <para>
                    <itemizedlist>
                        <listitem>
                            <para><code>SetFillColor('red@0.2')</code>, A slightly transparent red
                                color</para>
                        </listitem>
                        <listitem>
                            <para><code>SetFillColor('red@0.8')</code>, An almost completely
                                transparent color</para>
                        </listitem>
                    </itemizedlist>
                </para>
                <para>The result of using different alpha modifiers are shown in <xref
                        xlink:href="#fig.alpha-channel"/> where the blue color is made more and more
                    transparent to allow the red bar in the background to become more and more
                    visible.</para>
                <para>
                    <figure
                        xml:id="fig.alpha-channel">
                        <title>Using alpha channel modifiers</title>
                        <mediaobject>
                            <imageobject><imagedata
                                    scale="70"
                                    fileref="images/alpha-channel.png"/></imageobject>
                        </mediaobject>
                    </figure>
                </para>
                <para>As a final example of how to use transparency we show a graph in <xref
                        xlink:href="#fig.barlinealphaex1"/> that uses transparency to allow an area
                    plot to be mixed with a bar graph.</para>
                <para>
                    <programlisting>#=barlinealphaex1|Making use of transparency to combine two plots#</programlisting>
                </para>
                <tip>
                    <para>For all graph examples shown in this manual you can always click on the
                        file name in the title of the graph to view the actual source that created
                        the graph.</para>
                </tip>
            </sect2>
            <sect2>
                <title>Adjusting the brightness</title>
                <para>Since all colors that can be displayed on a computer can be modeled with the
                    appropriate RGB triple the above ways will allow you to specify any colors you
                    might need. However, conceptually it might be easier to think of colors in terms
                    of "a light blue" instead of a modified RGB triple so the library allows you to
                    take a basic color and apply a brightness correction factor.</para>
                <para>The brightness factor is a postfix to the color string separated from the core
                    color with a ':' (colon) character. The brightness factor is a real number in
                    the range of [0.0, 2.0]. Using a brightness factor of 0.0 means that the color
                    will be black (no brightness at all) and a factor of 2.0 means that the color is
                    white (maximum brightness). Using a factor of 1 will leave the original color
                    untouched.</para>
                <para>The brightness factor can be specified for named and HTML colors, see <xref
                        xlink:href="#fig.orange-scale"> </xref> and <xref
                        xlink:href="#fig.blueish-scale"/> for more examples how the factor adjusts
                    the color.</para>
                <para>For example, the following code snippets show valid color brightness
                    modifiers</para>
                <para>
                    <itemizedlist>
                        <listitem>
                            <para><code>SetColor('red:0.8');</code>, A slightly darker red
                                color</para>
                        </listitem>
                        <listitem>
                            <para><code>SetColor('red:1.5');</code>, A brighter red color</para>
                        </listitem>
                        <listitem>
                            <para><code>SetColor('#3485a9:1.8);</code>, A bright blue-greenish
                                color</para>
                        </listitem>
                    </itemizedlist>
                </para>
                <figure
                    xml:id="fig.orange-scale">
                    <title>Adjusting brightness of named color specifier</title>
                    <mediaobject>
                        <imageobject><imagedata
                                scale="70"
                                fileref="images/orange-scale.png"/></imageobject>
                    </mediaobject>
                </figure>
                <figure
                    xml:id="fig.blueish-scale">
                    <title>Adjusting brightness of a HTML color specifier</title>
                    <mediaobject>
                        <imageobject><imagedata
                                scale="70"
                                fileref="images/blueish-scale.png"/></imageobject>
                    </mediaobject>
                </figure>
                <note>
                    <para>The brightness factor is a purely linear factor but due to the human eyes
                        non-linear sensitivity for colors the perceived difference between (for
                        example) "<code>red:1.1</code>" and "<code>red:1.2</code>" than between
                            "<code>red:0.2</code>" and "<code>red:0.3</code>" even though the
                        relative difference is the same.</para>
                </note>
            </sect2>
            <sect2>
                <title>Combining brightness and transparency adjustment</title>
                <para>It is also possible to combine the two previous discussed modifiers. This is
                    done by first adding the transparency specifier and then the brightness
                    adjustment as the following examples demonstrates.</para>
                <para>
                    <itemizedlist>
                        <listitem>
                            <para><code>SetColor('red@0.7:1.2')</code>, A highly transparent
                                slightly bright red color</para>
                        </listitem>
                        <listitem>
                            <para><code>SetFillColor('#4545aa@0.3:1.5')</code>, A bright blueish
                                semi transparent color</para>
                        </listitem>
                    </itemizedlist>
                </para>
            </sect2>
        </sect1>
        <sect1>
            <title>Additional color handling</title>
            <para>Some plot types have additional color handling to facilitate easier handling and
                differentiation between data sets.</para>
            <para>
                <variablelist>
                    <varlistentry>
                        <term>Pie plots</term>
                        <listitem>
                            <para>Pie plots support the concept of color-themes. A color theme is
                                simple a set of colors used for consecutive slices within the Pie.
                                How to specify color-themes is further discussed in <xref
                                    xlink:href="#sec.pie-color-themes"/>.</para>
                        </listitem>
                    </varlistentry>
                    <varlistentry>
                        <term>Color maps</term>
                        <listitem>
                            <para>Matrix (Only available in the Pro-version) and contour plots also
                                have the concept of color maps. This is a range of colors used to
                                indicate the data in the plot. Examples of color maps can be found
                                in <xref
                                    xlink:href="#sec.built-in-colormaps"/>. (Color maps are defined
                                and implemented in
                                "<filename>jpgraph_colormap.inc.php</filename>").</para>
                        </listitem>
                    </varlistentry>
                </variablelist>
            </para>
        </sect1>
    </chapter>
    <chapter
        xml:id="chap.text_handling">
        <title>Text and font handling</title>
        <para>Before reading this chapter please make sure that your installation supports TTF fonts
            if you intend to use them (See <xref
                xlink:href="#sec.sys-req"/>). The rest of this chapter assumes that a working
            installation with TTF fonts is available when needed.</para>
        <para>
            <note>
                <para>It is highly recommended to create a setup where TTF fonts work since the
                    visual quality is significantly better than for the built-in bitmap fonts. In
                    addition the bitmap fonts are restricted to only display plain 7-bit ASCII
                    characters which means that no accented characters can be displayed, for example
                    the Scandinavian characters "".</para>
            </note>
        </para>
        <para>
            <note>
                <para>All files in the library are encoded in utf-8.</para>
            </note>
        </para>
        <sect1>
            <title>Different types of fonts</title>
            <para>The library supports two fundamental types of fonts.</para>
            <para>
                <orderedlist>
                    <listitem>
                        <para><emphasis
                                role="bold">Bitmap fonts</emphasis></para>
                        <para>There are three built in bitmap fonts. They are available as font
                            families <code>FF_FONT0</code>, <code>FF_FONT1</code> and
                                <code>FF_FONT2</code>. The advantage with bitmap fonts is that they
                            are always available in all installations of GD. However, bitmap fonts
                            only supports 7-bit ASCII so if you need to display any character from
                            the extended character set it is not possible to use bitmap fonts. The
                            available sizes of the bitmap fonts are also limited, the three
                            available size corresponds to the three families where
                                <code>FF_FONT0</code> is the smallest and <code>FF_FONT2</code> the
                            largest available bitmap font.</para>
                        <para>Bitmap fonts also has a more "rugged" look since they do not use
                            anti-aliasing.</para>
                        <para><emphasis
                                role="bold">Example:</emphasis>
                            <emphasis
                                role="italic">The following script lines shows a typical use of bit
                                map font specified for the title of a graph</emphasis></para>
                        <para>
                            <programlisting>&lt;?php
$graph = new Graph(....);

//  Adjust the title to use the largest built-in bitmap font in bold face
$graph->title->SetFont(FF_FONT2,FS_BOLD);
?></programlisting>
                        </para>
                        <para>The remainder of this chapter will describe this in more
                            details.</para>
                    </listitem>
                    <listitem>
                        <para><emphasis
                                role="bold">TTF Fonts (True Type Fonts)</emphasis></para>
                        <para>True Type Fonts (TTF) give a much better visual quality of the text.
                            They are available in all sizes and there are many more font family to
                            choose from. All font family specification apart from the three bitmap
                            fonts are TTF fonts. In order to use these fonts the installation must
                            be configured in the right way which is described in <xref
                                xlink:href="#sec.sys-req"/>. It is necessary to use TTF fonts in
                            order to display extended character sets (outside the traditional 7-bit
                            ASCII). TTF fonts must also be used when inserting unicode entities as
                            described in <xref
                                xlink:href="#sec.inserting-unicode"/></para>
                        <para>In order to be able to use TTF fonts it is necessary to check if the
                            installations supports this. See <xref
                                xlink:href="#sec.sys-req"/></para>
                        <para><emphasis
                                role="bold">Example:</emphasis>
                            <emphasis
                                role="italic">The following script lines shows a typical use of the
                                Arial TTF fonts for the title of a graph</emphasis></para>
                        <para>
                            <programlisting>&lt;?php
$graph = new Graph(....);

//  Adjust the title to use 14pt Arial bold face
$graph->title->SetFont(FF_ARIAL,FS_BOLD,14);
?></programlisting>
                        </para>
                    </listitem>
                </orderedlist>
            </para>
        </sect1>
        <sect1>
            <title>Font families and font styles</title>
            <para>All graph objects that uses text allows you to specify the font to be used by
                calling a <code>SetFont()</code> method and specifying three parameters.</para>
            <para>
                <orderedlist>
                    <listitem>
                        <para>The font family. This could for example be "Arial", "Times roman" for
                            TTF fonts or "Bitmap font medium size" when using bit-mapped fonts. The
                            font family is specified by using a symbolic constant that starts with
                            the prefix "<code>FF_</code>" (for <emphasis
                                role="bold">F</emphasis>ont <emphasis
                                role="bold">F</emphasis>amily). A list of all supported font
                            families are shown in <xref
                                xlink:href="#table.font-families"/>.</para>
                    </listitem>
                    <listitem>
                        <para>The font style. This specifies if the font should be emphasized as
                            italic, bold, or bold-italic. By default all fonts are rendered with the
                            "normal" style. The fonts style is specified with a symbolic constant
                            that starts with the prefix "<code>FS_</code>" (for <emphasis
                                role="bold">F</emphasis>ont <emphasis
                                role="bold">S</emphasis>tyle). The supported font styles are:</para>
                        <para>
                            <table
                                frame="all">
                                <title>Supported Font Styles</title>
                                <tgroup
                                    cols="2">
                                    <colspec
                                        colname="c1"
                                        colnum="1"/>
                                    <colspec
                                        colname="c2"
                                        colnum="2"/>
                                    <thead>
                                        <row>
                                            <entry>Font style specifier</entry>
                                            <entry>Description</entry>
                                        </row>
                                    </thead>
                                    <tbody>
                                        <row>
                                            <entry>FS_NORMAL</entry>
                                            <entry>Normal font style</entry>
                                        </row>
                                        <row>
                                            <entry>FS_BOLD</entry>
                                            <entry>Bold font style</entry>
                                        </row>
                                        <row>
                                            <entry>FS_ITALIC</entry>
                                            <entry>Italic font style</entry>
                                        </row>
                                        <row>
                                            <entry>FS_BOLDITALIC</entry>
                                            <entry>Bold + Italic style for font families that
                                                support this</entry>
                                        </row>
                                    </tbody>
                                </tgroup>
                            </table>
                        </para>
                        <para>Please note that not all font families support all available styles.
                        </para>
                    </listitem>
                    <listitem>
                        <para>The font size. This is specified as an integer and depicts the size of
                            the font given in typographic points (pt). </para>
                    </listitem>
                </orderedlist>
            </para>
            <para>
                <table
                    frame="all"
                    xml:id="table.font-families">
                    <title>Supported Latin Font family specifiers</title>
                    <tgroup
                        cols="6">
                        <colspec
                            colname="c1"
                            colnum="1"/>
                        <colspec
                            colname="c2"
                            colnum="2"/>
                        <colspec
                            colname="c3"
                            colnum="3"/>
                        <colspec
                            colname="newCol4"
                            colnum="4"/>
                        <colspec
                            colname="newCol5"
                            colnum="5"/>
                        <colspec
                            colname="newCol6"
                            colnum="6"/>
                        <thead>
                            <row>
                                <entry>Font family name</entry>
                                <entry>Type</entry>
                                <entry>Comment</entry>
                                <entry>Bold</entry>
                                <entry>Italic</entry>
                                <entry>BI</entry>
                            </row>
                        </thead>
                        <tbody>
                            <row>
                                <entry>FF_FONT0</entry>
                                <entry>Bitmap</entry>
                                <entry>A very small font</entry>
                                <entry> </entry>
                                <entry> </entry>
                                <entry> </entry>
                            </row>
                            <row>
                                <entry>FF_FONT1</entry>
                                <entry>Bitmap</entry>
                                <entry>A medium sized font</entry>
                                <entry><inlinemediaobject><imageobject><imagedata
                                                fileref="../css_stylesheets/checkmark-plain.gif"/></imageobject></inlinemediaobject></entry>
                                <entry><inlinemediaobject><imageobject><imagedata
                                                fileref="../css_stylesheets/checkmark-plain.gif"/></imageobject></inlinemediaobject></entry>
                                <entry><inlinemediaobject><imageobject><imagedata
                                                fileref="../css_stylesheets/checkmark-plain.gif"/></imageobject></inlinemediaobject></entry>
                            </row>
                            <row>
                                <entry>FF_FONT2</entry>
                                <entry>Bitmap</entry>
                                <entry>The largest bit mapped font</entry>
                                <entry><inlinemediaobject><imageobject><imagedata
                                                fileref="../css_stylesheets/checkmark-plain.gif"/></imageobject></inlinemediaobject></entry>
                                <entry><inlinemediaobject><imageobject><imagedata
                                                fileref="../css_stylesheets/checkmark-plain.gif"/></imageobject></inlinemediaobject></entry>
                                <entry><inlinemediaobject><imageobject><imagedata
                                                fileref="../css_stylesheets/checkmark-plain.gif"/></imageobject></inlinemediaobject></entry>
                            </row>
                            <row>
                                <entry>FF_ARIAL</entry>
                                <entry>TTF</entry>
                                <entry>Arial font</entry>
                                <entry><inlinemediaobject><imageobject><imagedata
                                                fileref="../css_stylesheets/checkmark-plain.gif"/></imageobject></inlinemediaobject></entry>
                                <entry><inlinemediaobject><imageobject><imagedata
                                                fileref="../css_stylesheets/checkmark-plain.gif"/></imageobject></inlinemediaobject></entry>
                                <entry><inlinemediaobject><imageobject><imagedata
                                                fileref="../css_stylesheets/checkmark-plain.gif"/></imageobject></inlinemediaobject></entry>
                            </row>
                            <row>
                                <entry>FF_VERDANA</entry>
                                <entry>TTF</entry>
                                <entry>Verdana font</entry>
                                <entry><inlinemediaobject><imageobject><imagedata
                                                fileref="../css_stylesheets/checkmark-plain.gif"/></imageobject></inlinemediaobject></entry>
                                <entry><inlinemediaobject><imageobject><imagedata
                                                fileref="../css_stylesheets/checkmark-plain.gif"/></imageobject></inlinemediaobject></entry>
                                <entry><inlinemediaobject><imageobject><imagedata
                                                fileref="../css_stylesheets/checkmark-plain.gif"/></imageobject></inlinemediaobject></entry>
                            </row>
                            <row>
                                <entry>FF_COURIER</entry>
                                <entry>TTF</entry>
                                <entry>Fixed pitched Courier new font</entry>
                                <entry><inlinemediaobject><imageobject><imagedata
                                                fileref="../css_stylesheets/checkmark-plain.gif"/></imageobject></inlinemediaobject></entry>
                                <entry><inlinemediaobject><imageobject><imagedata
                                                fileref="../css_stylesheets/checkmark-plain.gif"/></imageobject></inlinemediaobject></entry>
                                <entry><inlinemediaobject><imageobject><imagedata
                                                fileref="../css_stylesheets/checkmark-plain.gif"/></imageobject></inlinemediaobject></entry>
                            </row>
                            <row>
                                <entry>FF_BOOK</entry>
                                <entry>TTF</entry>
                                <entry>Bookman</entry>
                                <entry><inlinemediaobject><imageobject><imagedata
                                                fileref="../css_stylesheets/checkmark-plain.gif"/></imageobject></inlinemediaobject></entry>
                                <entry><inlinemediaobject><imageobject><imagedata
                                                fileref="../css_stylesheets/checkmark-plain.gif"/></imageobject></inlinemediaobject></entry>
                                <entry><inlinemediaobject><imageobject><imagedata
                                                fileref="../css_stylesheets/checkmark-plain.gif"/></imageobject></inlinemediaobject></entry>
                            </row>
                            <row>
                                <entry>FF_COMIC</entry>
                                <entry>TTF</entry>
                                <entry>Comic sans</entry>
                                <entry><inlinemediaobject><imageobject><imagedata
                                                fileref="../css_stylesheets/checkmark-plain.gif"/></imageobject></inlinemediaobject></entry>
                                <entry/>
                                <entry><inlinemediaobject><imageobject><imagedata
                                                fileref="../css_stylesheets/checkmark-plain.gif"/></imageobject></inlinemediaobject></entry>
                            </row>
                            <row>
                                <entry>FF_TIMES</entry>
                                <entry>TTF</entry>
                                <entry>Times New Roman</entry>
                                <entry><inlinemediaobject><imageobject><imagedata
                                                fileref="../css_stylesheets/checkmark-plain.gif"/></imageobject></inlinemediaobject></entry>
                                <entry><inlinemediaobject><imageobject><imagedata
                                                fileref="../css_stylesheets/checkmark-plain.gif"/></imageobject></inlinemediaobject></entry>
                                <entry><inlinemediaobject><imageobject><imagedata
                                                fileref="../css_stylesheets/checkmark-plain.gif"/></imageobject></inlinemediaobject></entry>
                            </row>
                            <row>
                                <entry>FF_GEORGIA</entry>
                                <entry>TTF</entry>
                                <entry>Georgia</entry>
                                <entry><inlinemediaobject><imageobject><imagedata
                                                fileref="../css_stylesheets/checkmark-plain.gif"/></imageobject></inlinemediaobject></entry>
                                <entry><inlinemediaobject><imageobject><imagedata
                                                fileref="../css_stylesheets/checkmark-plain.gif"/></imageobject></inlinemediaobject></entry>
                                <entry><inlinemediaobject><imageobject><imagedata
                                                fileref="../css_stylesheets/checkmark-plain.gif"/></imageobject></inlinemediaobject></entry>
                            </row>
                            <row>
                                <entry>FF_TREBUCHE</entry>
                                <entry>TTF</entry>
                                <entry>Trebuche</entry>
                                <entry><inlinemediaobject><imageobject><imagedata
                                                fileref="../css_stylesheets/checkmark-plain.gif"/></imageobject></inlinemediaobject></entry>
                                <entry><inlinemediaobject><imageobject><imagedata
                                                fileref="../css_stylesheets/checkmark-plain.gif"/></imageobject></inlinemediaobject></entry>
                                <entry><inlinemediaobject><imageobject><imagedata
                                                fileref="../css_stylesheets/checkmark-plain.gif"/></imageobject></inlinemediaobject></entry>
                            </row>
                            <row>
                                <entry>FF_VERA</entry>
                                <entry>TTF</entry>
                                <entry>Gnome Vera font. All Vera family fonts are available from <uri
                                        xlink:href="http://www.gnome.org/fonts/">http://www.gnome.org/fonts/</uri>
                                </entry>
                                <entry><inlinemediaobject><imageobject><imagedata
                                                fileref="../css_stylesheets/checkmark-plain.gif"/></imageobject></inlinemediaobject></entry>
                                <entry><inlinemediaobject><imageobject><imagedata
                                                fileref="../css_stylesheets/checkmark-plain.gif"/></imageobject></inlinemediaobject></entry>
                                <entry><inlinemediaobject><imageobject><imagedata
                                                fileref="../css_stylesheets/checkmark-plain.gif"/></imageobject></inlinemediaobject></entry>
                            </row>
                            <row>
                                <entry>FF_VERAMONO</entry>
                                <entry>TTF</entry>
                                <entry>Gnome Vera Mono font</entry>
                                <entry><inlinemediaobject><imageobject><imagedata
                                                fileref="../css_stylesheets/checkmark-plain.gif"/></imageobject></inlinemediaobject></entry>
                                <entry><inlinemediaobject><imageobject><imagedata
                                                fileref="../css_stylesheets/checkmark-plain.gif"/></imageobject></inlinemediaobject></entry>
                                <entry><inlinemediaobject><imageobject><imagedata
                                                fileref="../css_stylesheets/checkmark-plain.gif"/></imageobject></inlinemediaobject></entry>
                            </row>
                            <row>
                                <entry>FF_VERASERIF</entry>
                                <entry>TTF</entry>
                                <entry>Gnome Vera Serif font</entry>
                                <entry><inlinemediaobject><imageobject><imagedata
                                                fileref="../css_stylesheets/checkmark-plain.gif"/></imageobject></inlinemediaobject></entry>
                                <entry/>
                                <entry><inlinemediaobject><imageobject><imagedata
                                                fileref="../css_stylesheets/checkmark-plain.gif"/></imageobject></inlinemediaobject></entry>
                            </row>
                            <row>
                                <entry>FF_DV_SANSSERIF</entry>
                                <entry>TTF</entry>
                                <entry>DejaVu Font family. The DejaVu fonts are modifications of the
                                    Bitstream Vera fonts designed to extend this original for
                                    greater coverage of Unicode, as well as providing more styles.
                                    These fonts are available from <uri
                                        xlink:href="http://dejavu-fonts.org/">http://dejavu-fonts.org/</uri>
                                </entry>
                                <entry><inlinemediaobject><imageobject><imagedata
                                                fileref="../css_stylesheets/checkmark-plain.gif"/></imageobject></inlinemediaobject></entry>
                                <entry><inlinemediaobject><imageobject><imagedata
                                                fileref="../css_stylesheets/checkmark-plain.gif"/></imageobject></inlinemediaobject></entry>
                                <entry><inlinemediaobject><imageobject><imagedata
                                                fileref="../css_stylesheets/checkmark-plain.gif"/></imageobject></inlinemediaobject></entry>
                            </row>
                            <row>
                                <entry>FF_DV_SANSSERIFMONO</entry>
                                <entry>TTF</entry>
                                <entry>DejaVu Font family. </entry>
                                <entry><inlinemediaobject><imageobject><imagedata
                                                fileref="../css_stylesheets/checkmark-plain.gif"/></imageobject></inlinemediaobject></entry>
                                <entry><inlinemediaobject><imageobject><imagedata
                                                fileref="../css_stylesheets/checkmark-plain.gif"/></imageobject></inlinemediaobject></entry>
                                <entry><inlinemediaobject><imageobject><imagedata
                                                fileref="../css_stylesheets/checkmark-plain.gif"/></imageobject></inlinemediaobject></entry>
                            </row>
                            <row>
                                <entry>FF_DV_SANSSERIFCOND</entry>
                                <entry>TTF</entry>
                                <entry>DejaVu Font family. </entry>
                                <entry><inlinemediaobject><imageobject><imagedata
                                                fileref="../css_stylesheets/checkmark-plain.gif"/></imageobject></inlinemediaobject></entry>
                                <entry><inlinemediaobject><imageobject><imagedata
                                                fileref="../css_stylesheets/checkmark-plain.gif"/></imageobject></inlinemediaobject></entry>
                                <entry><inlinemediaobject><imageobject><imagedata
                                                fileref="../css_stylesheets/checkmark-plain.gif"/></imageobject></inlinemediaobject></entry>
                            </row>
                            <row>
                                <entry>FF_DV_SERIF</entry>
                                <entry>TTF</entry>
                                <entry>DejaVu Font family. </entry>
                                <entry><inlinemediaobject><imageobject><imagedata
                                                fileref="../css_stylesheets/checkmark-plain.gif"/></imageobject></inlinemediaobject></entry>
                                <entry><inlinemediaobject><imageobject><imagedata
                                                fileref="../css_stylesheets/checkmark-plain.gif"/></imageobject></inlinemediaobject></entry>
                                <entry><inlinemediaobject><imageobject><imagedata
                                                fileref="../css_stylesheets/checkmark-plain.gif"/></imageobject></inlinemediaobject></entry>
                            </row>
                            <row>
                                <entry>FF_DV_SERIFCOND</entry>
                                <entry>TTF</entry>
                                <entry>DejaVu Font family. </entry>
                                <entry><inlinemediaobject><imageobject><imagedata
                                                fileref="../css_stylesheets/checkmark-plain.gif"/></imageobject></inlinemediaobject></entry>
                                <entry><inlinemediaobject><imageobject><imagedata
                                                fileref="../css_stylesheets/checkmark-plain.gif"/></imageobject></inlinemediaobject></entry>
                                <entry><inlinemediaobject><imageobject><imagedata
                                                fileref="../css_stylesheets/checkmark-plain.gif"/></imageobject></inlinemediaobject></entry>
                            </row>
                            <row>
                                <entry>FF_CHINESE, FF_BIG5</entry>
                                <entry>TTF</entry>
                                <entry>
                                    <para><emphasis
                                            role="bold"><emphasis
                                                role="italic">Chinese font</emphasis></emphasis>
                                        (both symbolic names can be used). </para>
                                    <para>The actual font file name used for the Chinese font is
                                            "<filename>bkai00mp.ttf</filename>". The name of this
                                        file can be changed in the define
                                            <code>CHINESE_TTF_FONT</code> available in the library
                                        file <filename>jpgraph_ttf.inc.php</filename>
                                    </para>
                                </entry>
                                <entry> </entry>
                                <entry> </entry>
                                <entry> </entry>
                            </row>
                            <row>
                                <entry>FF_SIMSUN</entry>
                                <entry>TTF</entry>
                                <entry>
                                    <para><emphasis
                                            role="bold"><emphasis
                                                role="italic">Chinese font.
                                        </emphasis></emphasis></para>
                                    <para>The actual font file name is
                                            "<filename>simsun.ttc</filename>"</para>
                                </entry>
                                <entry> </entry>
                                <entry> </entry>
                                <entry> </entry>
                            </row>
                            <row>
                                <entry>FF_MINCHO</entry>
                                <entry>TTF</entry>
                                <entry>
                                    <para><emphasis
                                            role="bold"><emphasis
                                                role="italic">Japanese
                                        font.</emphasis></emphasis></para>
                                    <para>The actual font file name is
                                            "<filename>ipam.ttf</filename>"</para>
                                </entry>
                                <entry> </entry>
                                <entry> </entry>
                                <entry> </entry>
                            </row>
                            <row>
                                <entry>FF_PMINCHO</entry>
                                <entry>TTF</entry>
                                <entry>
                                    <para><emphasis
                                            role="bold"><emphasis
                                                role="italic">Japanese
                                        font.</emphasis></emphasis></para>
                                    <para>The actual font file name is
                                            "<filename>ipamp.ttf</filename>"</para>
                                </entry>
                                <entry> </entry>
                                <entry> </entry>
                                <entry> </entry>
                            </row>
                            <row>
                                <entry>FF_GOTHIC</entry>
                                <entry>TTF</entry>
                                <entry>
                                    <para><emphasis
                                            role="bold"><emphasis
                                                role="italic">Japanese
                                        font.</emphasis></emphasis></para>
                                    <para>The actual font file name is
                                            "<filename>ipag.ttf</filename>"</para>
                                </entry>
                                <entry> </entry>
                                <entry> </entry>
                                <entry> </entry>
                            </row>
                            <row>
                                <entry>FF_PGOTHIC</entry>
                                <entry>TTF</entry>
                                <entry>
                                    <para><emphasis
                                            role="bold"><emphasis
                                                role="italic">Japanese
                                        font.</emphasis></emphasis></para>
                                    <para>The actual font file name is
                                            "<filename>ipagp.ttf</filename>"</para>
                                </entry>
                                <entry> </entry>
                                <entry> </entry>
                                <entry> </entry>
                            </row>
                            <row>
                                <entry>FF_DAVID</entry>
                                <entry>TTF</entry>
                                <entry>
                                    <para><emphasis
                                            role="bold"><emphasis
                                                role="italic">Hebrew
                                        font.</emphasis></emphasis></para>
                                    <para>The actual font file name is
                                            "<filename>DAVIDNEW.TTF</filename>"</para>
                                </entry>
                                <entry> </entry>
                                <entry> </entry>
                                <entry> </entry>
                            </row>
                            <row>
                                <entry>FF_MIRIAM</entry>
                                <entry>TTF</entry>
                                <entry>
                                    <para><emphasis
                                            role="bold"><emphasis
                                                role="italic">Hebrew
                                        font.</emphasis></emphasis></para>
                                    <para>The actual font file name is
                                            "<filename>MRIAMY.TTF</filename>"</para>
                                </entry>
                                <entry> </entry>
                                <entry> </entry>
                                <entry> </entry>
                            </row>
                            <row>
                                <entry>FF_AHRON</entry>
                                <entry>TTF</entry>
                                <entry>
                                    <para><emphasis
                                            role="bold"><emphasis
                                                role="italic">Hebrew
                                        font.</emphasis></emphasis></para>
                                    <para>The actual font file name is
                                            "<filename>ahronbd.ttf</filename>"</para>
                                </entry>
                                <entry> </entry>
                                <entry> </entry>
                                <entry> </entry>
                            </row>
                        </tbody>
                    </tgroup>
                </table>
            </para>
            <para>
                <note>
                    <para>Depending on what versions of the DejaVu fonts are installed on the system
                        there are two naming conventions for the font files in common practice. The
                        library will try both naming convention to see if it can find the font
                        files.</para>
                </note>
            </para>
            <para>In <xref
                    xlink:href="#fig.listfontsex1"/> all latin fonts are shown.</para>
            <para>
                <programlisting>#=listfontsex1|List of all latin TTF fonts.#</programlisting>
            </para>
        </sect1>
        <sect1>
            <title>Understanding text alignment and anchor point</title>
            <para>When a text string position is specified that screen (or scale) position by
                default gets aligned with the top left corner of the strings bounding box. We say
                that the top left corner is the <emphasis
                    role="italic">anchor point</emphasis> of the text string. The alignment of the
                anchor point can be adjusted with a call to <code>Text::SetAlignment($aHorAlign,
                    $vertAlign)</code>. The two arguments are given as text strings and the
                admissible values for each argument are: </para>
            <para>
                <variablelist>
                    <varlistentry>
                        <term>Horizontal alignment</term>
                        <listitem>
                            <para><code>'left'</code>, <code>'center'</code>,
                                <code>'right'</code></para>
                        </listitem>
                    </varlistentry>
                    <varlistentry>
                        <term>Vertical alignment</term>
                        <listitem>
                            <para><code>'bottom'</code>, <code>'center'</code> (or
                                    <code>'middle'</code>) , <code>'top'</code></para>
                        </listitem>
                    </varlistentry>
                </variablelist>
            </para>
            <caution>
                <para>Even though from an API perspective both bitmap fonts and TTF fonts share the
                    same user API the implementation is vastly different. There are a number of
                    subtle differences in the way built-in bit-map fonts and TrueType fonts are
                    rendered to the screen. This means for example that the alignment of, say the
                    bottom of the text string, is not pixel-perfect between bitmap and TrueType
                    fonts However, JpGraph, abstracts away 99.9% of the differences so it will be,
                    for all practical uses of the library completely transparent to switch between
                    the different font types.</para>
            </caution>
            <para>Manually setting the alignment for the anchor point is mostly useful when adding
                Text object to the graph to get the wanted alignment. You can see an example of how
                the anchor point changes depending on how the combination of alignments are used in <xref
                    xlink:href="#fig.textalignex1"/></para>
            <para>
                <programlisting>#=textalignex1|Illustration of anchor point alignment#</programlisting>
            </para>
            <para>
                <note>
                    <para>It might seem strange to have the method name
                        "<code>SetAlignment()</code>" when it really should make more sense to use
                        the name "<code>SetAnchor()</code>". We agree. This naming scheme is due to
                        historical reasons.</para>
                </note>
            </para>
            <para>
                <note>
                    <para>The graph legend box also have an anchor point that is specified as the
                        3:rd and 4:th argument to Legend::SetPos()</para>
                </note>
            </para>
        </sect1>
        <sect1>
            <title>Rotating text</title>
            <para>Both bit map and TTF fonts supports rotating text to different extent. With bit
                map fonts it is only possible to use horizontal or vertical text, i.e. 0 or 90
                degree rotation. TTF fonts supports arbitrary angles. If you are using a bit map
                font and specifies an angle other than 0 or 90 then an error will be
                displayed.</para>
            <para>The most common usage for rotating text is probably to adjust the labels on the
                x-axis so they are at 45 degrees angle. To rotate the label of an axis the method
                    <code>Axis::SetLabelAngle()</code> should be used. <xref
                    xlink:href="#fig.bargradex1"/> shows an example of this (click on the filename
                to view the actual code).</para>
            <para>
                <programlisting>#=bargradex1|Example of how to use rotated labels#</programlisting>
            </para>
            <para
                xlink:href="#fig.alpha-channel">In addition to axis label it is also possible to
                rotate almost every other text object with the exception of graph titles which is
                always horizontal. For text objects (the class <code>Text</code>) that can be added
                to arbitrary positions on the graph the method <code>Text::SetAngle()</code> can be
                used to specify the wanted text angle. Another common place where text labels are
                rotated is when individual data points are marked with labels. This could be done
                for most plot types and in <xref
                    xlink:href="#fig.example20.3"/> we show an example of using this for adding
                labels to a basic bar plot (click on the filename to view source).</para>
            <para>
                <programlisting>#=example20.3|Example of using rotated data point values#</programlisting>
            </para>
            <para>
                <caution>
                    <para>When rotating text paragraph the alignment (within the paragraph) will
                        always be reset to "left". It is not possible to use "center" or "right"
                        paragraph alignment in rotated texts.</para>
                </caution>
            </para>
        </sect1>
        <sect1>
            <title>Formatting text paragraphs</title>
            <para>The text rendering engine within the library offers some basic text paragraph
                formatting.</para>
            <para>
                <itemizedlist>
                    <listitem>
                        <para>It is possible to use multi line text combined as a paragraph</para>
                    </listitem>
                    <listitem>
                        <para>It is possible to adjust the text alignment within the paragraph to be
                            left, right or center adjusted. This works in the same way as you would
                            expect in a word-processor.</para>
                    </listitem>
                    <listitem>
                        <para>If enabled the text rendering will support automatic line breaks at a
                            certain column. The line breaks are intelligent not to break words in
                            the middle.</para>
                    </listitem>
                </itemizedlist>
            </para>
            <para>All text handling is centralized to the class <code>Text</code> (defined in file
                    <filename>jpgraph_text.inc.php</filename>) which is used both to add arbitrary
                text to the graph as well as internally within the library to manipulate text on
                labels and titles. All such texts are an instance of the Text class.</para>
            <para>The paragraph alignment is controlled by the method
                    <code>Text::SetParagraphAlign($aAlignment)</code>. The argument is a text string
                that should be one of <code>'left'</code>, <code>'right'</code> or
                    <code>'center'</code>. </para>
            <para>
                <note>
                    <para>Unfortunately the library does not support an "even" paragraph alignment
                        which in word processors adjust the kerning between individual characters to
                        make the text have even left and right sides. Implementing this would
                        require a much higher complexity than can be motivated for the type of text
                        needed in a graph library.</para>
                </note>
            </para>
            <para>In the <xref
                    xlink:href="#fig.textpalignex1"/> the same text paragraph is rendered with the
                possible paragraph alignments.</para>
            <para>
                <programlisting>#=textpalignex1|The different types of paragraph alignments#</programlisting>
            </para>
            <para>Inserting a newline character "\n" in text will cause the text line to break and
                start on the next row. Note that the newline must be surrounded with double-quotes
                and not single quotes.</para>
            <para>
                <note>
                    <para>Bitmap fonts that are rotated, i.e. vertical, does not support automatic
                        line breaking. If line breaking is needed with vertical text then one of the
                        TTF fonts muts be used.</para>
                </note>
            </para>
        </sect1>
        <sect1
            xml:id="sec.adding-custom-ttf-fonts">
            <title>Adding custom TTF fonts</title>
            <para>In addition to the predefined fonts it is possible to easily use up to three
                custom fonts. This is done by first specifying the name of the font file that should
                be used and then specifying the font family as either <code>FF_USERFONT1</code>,
                    <code>FF_USERFONT2</code> or <code>FF_USERFONT3</code>. A new font is installed
                by calling one or more of the methods</para>
            <para>
                <itemizedlist>
                    <listitem>
                        <para><code>Graph::SetUserFont1($aNormal,$aBold,$aItalic,$aBoldIt)</code>
                            (or the synonym <code>SetUserFont()</code> )</para>
                    </listitem>
                    <listitem>
                        <para><code>Graph::SetUserFont2($aNormal,$aBold,$aItalic,$aBoldIt)</code></para>
                    </listitem>
                    <listitem>
                        <para><code>Graph::SetUserFont3($aNormal,$aBold,$aItalic,$aBoldIt)</code></para>
                    </listitem>
                </itemizedlist>
            </para>
            <para>The argument to these methods should be the full font file name (including full
                path) for the normal, bold, italic and/or bolditalic variant of the font family. All
                arguments apart from "<code>$aNormal</code>" are optional. </para>
            <para>An example on how this can be used to use a special font for the title of a graph
                is shown in <!--    <xref xlink:href="#ex.user-font-ex1"/> -->
                <xref
                    xlink:href="#ex.user-font-ex1"/></para>
            <example
                xml:id="ex.user-font-ex1">
                <title>Specifying and installing a user specified font</title>
                <programlisting>#!userfont_ex1.php#</programlisting>
            </example>
        </sect1>
        <sect1
            xml:id="sec.inserting-unicode">
            <title>Inserting Unicode entities</title>
            <para>One reason for using TTF fonts is the possibility to inserting unicode
                character/entities. With this we mean characters from the extended range that are
                not normally available on West european keyboards. This could for example be
                classical Greek characters often used in mathematics, for example the symbol for
                "pi". In order to make these and other commonly used "special" characters more
                accessible the library provides a utility class that makes it easy to use these
                characters without having to look up the corresponding unicode entities every
                time.</para>
            <para>In order to specify characters not available on the keyboard the normal way is to
                specify there unicode code and included it in the text string with the prefix
                "&amp;#". For example the unicode for the character "pi" is "03C0" in hex so to
                include this character in a text string you would have to write "This is pi
                &amp;#0960;" note that the code should be given in decimal encoding in the string
                and always use 4 digits (pre-padded with 0:s as necessary). Since it is very tedious
                to lookup and encode special characters the library offers a simpler way. The
                    <code>SymChar</code> class. </para>
            <para>
                <note>
                    <para>This section can be skipped at first reading without loss of
                        continuity.</para>
                </note>
            </para>
            <sect2>
                <title>The utility class "SymChar"</title>
                <para>As described above it is tedious to have to lookup all the character codes. To
                    simplify this the SymChar class allows you to find these characters with the
                    english common name of these symbols instead. For example to create a string
                    with the Greek character "pi" one would have to write the code as shown
                    in.</para>
                <example
                    xml:id="ex.sym-char-ex1">
                    <title>Using the SymChar class to display the Greek letter "pi"</title>
                    <programlisting>#!symchar_ex1.php#</programlisting>
                </example>
                <para>All supported entities with there symbolic names are listed in <xref
                        xlink:href="#tab.sym-char-list"/>. The first argument to the static method
                        <code>SymChar::Get()</code> should be the name of the entity and if the
                    second optional argument is true then the capital version (if it exists) of the
                    symbol should be returned.</para>
                <para>
                    <table
                        frame="all"
                        xml:id="tab.sym-char-list">
                        <title>Supported character entities in class SymChar</title>
                        <tgroup
                            cols="4">
                            <colspec
                                colname="c1"
                                colnum="1"/>
                            <colspec
                                colname="c2"
                                colnum="2"/>
                            <colspec
                                colname="c3"
                                colnum="3"/>
                            <colspec
                                colname="c4"
                                colnum="4"/>
                            <thead>
                                <row>
                                    <entry>Name</entry>
                                    <entry>Unicode </entry>
                                    <entry>Unicode capital</entry>
                                    <entry>Comment</entry>
                                </row>
                            </thead>
                            <tbody>
                                <row>
                                    <entry>"alpha"</entry>
                                    <entry>03B1</entry>
                                    <entry>0391</entry>
                                    <entry>Greek character</entry>
                                </row>
                                <row>
                                    <entry>"beta"</entry>
                                    <entry>03B2</entry>
                                    <entry>0392</entry>
                                    <entry>Greek character</entry>
                                </row>
                                <row>
                                    <entry>"gamma"</entry>
                                    <entry>03B3</entry>
                                    <entry>0393</entry>
                                    <entry>Greek character</entry>
                                </row>
                                <row>
                                    <entry>"delta"</entry>
                                    <entry>03B4</entry>
                                    <entry>0394</entry>
                                    <entry>Greek character</entry>
                                </row>
                                <row>
                                    <entry>"epsilon"</entry>
                                    <entry>03B5</entry>
                                    <entry>0395</entry>
                                    <entry>Greek character</entry>
                                </row>
                                <row>
                                    <entry>"zeta"</entry>
                                    <entry>03B6</entry>
                                    <entry>0396</entry>
                                    <entry>Greek character</entry>
                                </row>
                                <row>
                                    <entry>"ny"</entry>
                                    <entry>03B7</entry>
                                    <entry>0397</entry>
                                    <entry>Greek character</entry>
                                </row>
                                <row>
                                    <entry>"eta"</entry>
                                    <entry>03B8</entry>
                                    <entry>0398</entry>
                                    <entry>Greek character</entry>
                                </row>
                                <row>
                                    <entry>"theta"</entry>
                                    <entry>03B8</entry>
                                    <entry>0398</entry>
                                    <entry>Greek character</entry>
                                </row>
                                <row>
                                    <entry>"iota"</entry>
                                    <entry>03B9</entry>
                                    <entry>0399</entry>
                                    <entry>Greek character</entry>
                                </row>
                                <row>
                                    <entry>"kappa"</entry>
                                    <entry>03BA</entry>
                                    <entry>039A</entry>
                                    <entry>Greek character</entry>
                                </row>
                                <row>
                                    <entry>"lambda"</entry>
                                    <entry>03BB</entry>
                                    <entry>039B</entry>
                                    <entry>Greek character</entry>
                                </row>
                                <row>
                                    <entry>"mu"</entry>
                                    <entry>03BC</entry>
                                    <entry>039C</entry>
                                    <entry>Greek character</entry>
                                </row>
                                <row>
                                    <entry>"nu"</entry>
                                    <entry>03BD</entry>
                                    <entry>039D</entry>
                                    <entry>Greek character</entry>
                                </row>
                                <row>
                                    <entry>"xi"</entry>
                                    <entry>03BE</entry>
                                    <entry>039E</entry>
                                    <entry>Greek character</entry>
                                </row>
                                <row>
                                    <entry>"omicron"</entry>
                                    <entry>03BF</entry>
                                    <entry>039F</entry>
                                    <entry>Greek character</entry>
                                </row>
                                <row>
                                    <entry>"pi"</entry>
                                    <entry>03C0</entry>
                                    <entry>03A0</entry>
                                    <entry>Greek character</entry>
                                </row>
                                <row>
                                    <entry>"rho"</entry>
                                    <entry>03C1</entry>
                                    <entry>03A1</entry>
                                    <entry>Greek character</entry>
                                </row>
                                <row>
                                    <entry>"sigma"</entry>
                                    <entry>03C3</entry>
                                    <entry>03A3</entry>
                                    <entry>Greek character</entry>
                                </row>
                                <row>
                                    <entry>"tau"</entry>
                                    <entry>03C4</entry>
                                    <entry>03A4</entry>
                                    <entry>Greek character</entry>
                                </row>
                                <row>
                                    <entry>"upsilon"</entry>
                                    <entry>03C5</entry>
                                    <entry>03A5</entry>
                                    <entry>Greek character</entry>
                                </row>
                                <row>
                                    <entry>"phi"</entry>
                                    <entry>03C6</entry>
                                    <entry>03A6</entry>
                                    <entry>Greek character</entry>
                                </row>
                                <row>
                                    <entry>"chi"</entry>
                                    <entry>03C7</entry>
                                    <entry>03A7</entry>
                                    <entry>Greek character</entry>
                                </row>
                                <row>
                                    <entry>"psi"</entry>
                                    <entry>03C8</entry>
                                    <entry>03A8</entry>
                                    <entry>Greek character</entry>
                                </row>
                                <row>
                                    <entry>"omega"</entry>
                                    <entry>03C9</entry>
                                    <entry>03A9</entry>
                                    <entry>Greek character</entry>
                                </row>
                                <row>
                                    <entry>"euro"</entry>
                                    <entry>20AC</entry>
                                    <entry> </entry>
                                    <entry>Monetary symbol</entry>
                                </row>
                                <row>
                                    <entry>"yen"</entry>
                                    <entry>00A5</entry>
                                    <entry> </entry>
                                    <entry>Monetary symbol</entry>
                                </row>
                                <row>
                                    <entry>"pound"</entry>
                                    <entry>20A4</entry>
                                    <entry> </entry>
                                    <entry>Monetary symbol</entry>
                                </row>
                                <row>
                                    <entry>"approx"</entry>
                                    <entry>2248</entry>
                                    <entry> </entry>
                                    <entry>Mathematical</entry>
                                </row>
                                <row>
                                    <entry>"neq"</entry>
                                    <entry>2260</entry>
                                    <entry> </entry>
                                    <entry>Mathematical</entry>
                                </row>
                                <row>
                                    <entry>"not"</entry>
                                    <entry>2310</entry>
                                    <entry> </entry>
                                    <entry>Mathematical</entry>
                                </row>
                                <row>
                                    <entry>"def"</entry>
                                    <entry>2261</entry>
                                    <entry> </entry>
                                    <entry>Mathematical</entry>
                                </row>
                                <row>
                                    <entry>"inf"</entry>
                                    <entry>221E</entry>
                                    <entry> </entry>
                                    <entry>Mathematical</entry>
                                </row>
                                <row>
                                    <entry>"sqrt"</entry>
                                    <entry>221A</entry>
                                    <entry> </entry>
                                    <entry>Mathematical</entry>
                                </row>
                                <row>
                                    <entry>"int"</entry>
                                    <entry>222B</entry>
                                    <entry> </entry>
                                    <entry>Mathematical</entry>
                                </row>
                                <row>
                                    <entry>"copy"</entry>
                                    <entry>00A9</entry>
                                    <entry> </entry>
                                    <entry>Misc symbols</entry>
                                </row>
                                <row>
                                    <entry>"para"</entry>
                                    <entry>00A7</entry>
                                    <entry> </entry>
                                    <entry>Misc symbols</entry>
                                </row>
                                <row>
                                    <entry>"tm"</entry>
                                    <entry>2122</entry>
                                    <entry> </entry>
                                    <entry>Misc symbols</entry>
                                </row>
                                <row>
                                    <entry>"rtm"</entry>
                                    <entry>00AE</entry>
                                    <entry> </entry>
                                    <entry>Misc symbols</entry>
                                </row>
                            </tbody>
                        </tgroup>
                    </table>
                </para>
                <para><xref
                        xlink:href="#fig.sym-char-list"/> and <xref
                        xlink:href="#fig.sym-char-capital-list"/> shows how these symbol look when
                    they are rendered with the TTF font <emphasis
                        role="italic">Times Roman 14pt</emphasis>. The symbols are in the same order
                    as in the table above and are visually grouped by there category as specified in
                    the column "Comment" in the table above.</para>
                <para>
                    <figure
                        xml:id="fig.sym-char-list">
                        <title>Rendered symbol characters corresponding to
                            <!-- <xref xlink:href="#tab.sym-char-list"/> -->
                        </title>
                        <mediaobject>
                            <imageobject><imagedata
                                    scale="70"
                                    fileref="images/sym-char-list.png"/></imageobject>
                        </mediaobject>
                    </figure>
                </para>
                <para>
                    <figure
                        xml:id="fig.sym-char-capital-list">
                        <title>Rendered capital symbol characters corresponding to <xref
                                xlink:href="#tab.sym-char-list"/>. </title>
                        <mediaobject>
                            <imageobject><imagedata
                                    scale="70"
                                    fileref="images/sym-char-list-capital.png"/></imageobject>
                        </mediaobject>
                    </figure>
                </para>
            </sect2>
            <sect2>
                <title>Graph example with Greek labels</title>
                <para>In <xref
                        xlink:href="#fig.manualtickex2"/> we have used the previous discussed
                        <code>SymChar</code> class to more readily insert "" characters in the
                    X-axis label. We highlight some functionality that we haven't yet discussed in
                    detail</para>
                <para>
                    <orderedlist>
                        <listitem>
                            <para>We use a utility class (<code>FuncGenerator</code> available in
                                    "<filename>jpgraph_utils.inc.php</filename>") to help create
                                plot values from a mathematical expression. This will help create a
                                set of (x,y) points that can later on be used as the base for a data
                                series.</para>
                        </listitem>
                        <listitem>
                            <para>The x-axis labels and the position of the tick marks on the x-axis
                                are manually positioned and specified to be positioned at "even"
                                fractions of .</para>
                        </listitem>
                    </orderedlist>
                </para>
                <para>
                    <programlisting>#=manualtickex2|Specifying manual ticks as fraction of Pi.#</programlisting>
                </para>
            </sect2>
        </sect1>
        <sect1
            xml:id="sec1.character-encoding">
            <title>Character encoding</title>
            <para><note>
                    <para>If you are not using Japanese, Chinese, Cyrillic , Greek or Hebrew
                        languages then this section can be safely skipped.</para>
                </note>The core problem for the library is that it has no way of knowing in what
                input encoding the string given to the library is using. Hence it is necessary to,
                sometime, tell the library what input encoding is being used in order for the
                library to do necessary character encoding conversion to generate UTF-8 (or UTF-16)
                as needed to properly render the TTF fonts. The specific encoding options for each
                major supported locale are explained below.</para>
            <para>By default all JpGraph library files and examples are encoded in UTF-8</para>
            <para>All defines mentioned below can be found in the file
                    "<filename>jpgraph_ttf.inc.php</filename>" </para>
            <sect2>
                <title>Japanese encoding options</title>
                <para>There is only one possible option that can be specified.</para>
                <para>
                    <table
                        frame="all">
                        <title>Japanese encoding options</title>
                        <tgroup
                            cols="3">
                            <colspec
                                colname="c1"
                                colnum="1"/>
                            <colspec
                                colname="c2"
                                colnum="2"/>
                            <colspec
                                colname="c3"
                                colnum="3"/>
                            <thead>
                                <row>
                                    <entry>Symbolic define</entry>
                                    <entry>Possible values </entry>
                                    <entry>Description</entry>
                                </row>
                            </thead>
                            <tbody>
                                <row>
                                    <entry><code>ASSUME_EUCJP_ENCODING</code></entry>
                                    <entry>true/false</entry>
                                    <entry>Assumes that Japanese text have been entered in EUC-JP
                                        encoding. If this define is true then conversion from EUC-JP
                                        to UTF8 is done automatically in the library using the
                                            <code>mbstring</code> module in PHP. Note that the
                                        multibyte extension in PHP is not normally enabled.</entry>
                                </row>
                            </tbody>
                        </tgroup>
                    </table>
                </para>
                <para>Otherwise it is assumed that the input characters are encoded in UTF-8.
                    Remember that to show the Japanese character sets (Kanji, Hiragana and Katakana)
                    one of the Japanese font families (<code>FF_MINCHO</code>,
                        <code>FF_PMINCHO</code>, <code>FF_GOTHIC</code> or <code>FF_PGOTHIC</code>)
                    must be specified. </para>
                <para>An example of using Japanese locale together with Windrose plots can be seen
                    in <xref
                        xlink:href="#sec.windrose-locale-compass"/>.</para>
            </sect2>
            <sect2>
                <title>Chinese encoding options</title>
                <para>There are no specific settings that control the encoding. The following rules
                    are used depending on the font is specified. </para>
                <para>
                    <orderedlist>
                        <listitem>
                            <para>If the font is specified as <code>FF_SIMSUN</code> the built-in
                                library conversion from GB2312 to UTF-8 will be used. This
                                translation table is stored in the file
                                    <filename>jpgraph_gb2312.inc.php</filename>.</para>
                        </listitem>
                        <listitem>
                            <para>If the font is specified as <code>FF_CHINESE</code> then no
                                conversion is made since it is assumed that the input character
                                string is already in UTF-8 This only has the effect of changing the
                                font to the default Chinese font family.</para>
                        </listitem>
                        <listitem>
                            <para>If the font is specified as <code>FF_BIG5</code> then it is
                                assumed that the input character string is encoded in BIG5 and the
                                internal translation to UTF-8 is done by the <code>iconv()</code>
                                function. This means that PHP must be built with
                                    <code>iconv()</code> support. By default this is not compiled
                                into PHP (needs the "<code>--width-iconv</code>" when configured).
                                For more on building PHP with the right options see <xref
                                    xlink:href="#app.compile-php"/>. If this method is not present
                                the library will generate the following an error message.</para>
                        </listitem>
                    </orderedlist>
                </para>
                <para>An example of using Chinese encoding with Windrose plots can be seen in <xref
                        xlink:href="#fig.windrose_ex6.1"/>
                </para>
            </sect2>
            <sect2>
                <title>Cyrillic encoding options</title>
                <para>In order to do proper translation to unicode from cyrillic the
                        <code>LANGUAGE_CYRILLIC</code> define should be set to true. If you are
                    running the library in multiuser environment it might be necessary to also
                    adjust the <code>LANGUGAE_CHARSET</code> define as described below.</para>
                <para>
                    <table
                        frame="all">
                        <title>Cyrillic encoding options</title>
                        <tgroup
                            cols="3">
                            <colspec
                                colname="c1"
                                colnum="1"/>
                            <colspec
                                colname="c2"
                                colnum="2"/>
                            <colspec
                                colname="c3"
                                colnum="3"/>
                            <thead>
                                <row>
                                    <entry>Symbolic define</entry>
                                    <entry>Possible values </entry>
                                    <entry>Description</entry>
                                </row>
                            </thead>
                            <tbody>
                                <row>
                                    <entry><code>LANGUAGE_CYRILLIC</code></entry>
                                    <entry>true/false</entry>
                                    <entry>
                                        <para>Special unicode cyrillic language support</para>
                                    </entry>
                                </row>
                                <row>
                                    <entry><code>CYRILLIC_FROM_WINDOWS</code></entry>
                                    <entry>true/false</entry>
                                    <entry>
                                        <para>If you are setting this config to true the conversion
                                            will assume that the input text is encoded in windows
                                            1251, if false it will assume koi8-r</para>
                                    </entry>
                                </row>
                                <row>
                                    <entry><code>LANGUAGE_CHARSET</code></entry>
                                    <entry>string</entry>
                                    <entry>
                                        <para>This constant is used to auto-detect whether cyrillic
                                            conversion is really necessary if enabled. Just specify
                                            the encoding used, e.g. 'windows-1251', with a variable
                                            containing the input character encoding string of your
                                            application calling JpGraph. </para>
                                        <para>A typical such string would be 'UTF-8' or 'utf-8'. The
                                            comparison is case-insensitive. If this charset is not a
                                            'koi8-r' or 'windows-1251' derivate then no conversion
                                            is done. This constant can be very important in
                                            multi-user multi-language environments where a cyrillic
                                            conversion could be needed for some cyrillic people and
                                            resulting in just erroneous conversions for non cyrillic
                                            language based people. </para>
                                        <para>Example: In the free project management software
                                            dotproject.net <code>$locale_char_set</code> is
                                            dynamically set by the language environment the user has
                                            chosen. </para>
                                        <para>Usage: <code>define('LANGUAGE_CHARSET',
                                                $locale_char_set);</code> where
                                                <code>$locale_char_set</code> is a GLOBAL (string)
                                            variable from the application including JpGraph.</para>
                                    </entry>
                                </row>
                            </tbody>
                        </tgroup>
                    </table>
                </para>
            </sect2>
            <sect2>
                <title>Hebrew encoding options</title>
                <para>There are no user adjustable settings. The conversion is made from iso to
                    unicode with the help of the PHP method "<code>hebrev()</code>" which is used to
                    convert logical Hebrew text to visual text. This conversion is done
                    automatically when the font is one of <code>FF_DAVID</code>,
                        <code>FF_MIRIAM</code> or <code>FF_AHRON</code></para>
            </sect2>
            <sect2>
                <title>Greek encoding options</title>
                <para>In order to do proper translation to unicode from greek the
                        <code>LANGUAGE_GREEK</code> define should be specified to true.</para>
                <para>
                    <table
                        frame="all">
                        <title>Greek encoding options</title>
                        <tgroup
                            cols="3">
                            <colspec
                                colname="c1"
                                colnum="1"/>
                            <colspec
                                colname="c2"
                                colnum="2"/>
                            <colspec
                                colname="c3"
                                colnum="3"/>
                            <thead>
                                <row>
                                    <entry>Symbolic define</entry>
                                    <entry>Possible values </entry>
                                    <entry>Description</entry>
                                </row>
                            </thead>
                            <tbody>
                                <row>
                                    <entry><code>LANGUAGE_GREEK</code></entry>
                                    <entry>true/false</entry>
                                    <entry>Special unicode greek language support</entry>
                                </row>
                                <row>
                                    <entry><code>GREEK_FROM_WINDOWS</code></entry>
                                    <entry>true/false</entry>
                                    <entry>If you are setting this define to true the conversion of
                                        greek characters will assume that the input text is windows
                                        1251</entry>
                                </row>
                            </tbody>
                        </tgroup>
                    </table>
                </para>
            </sect2>
        </sect1>
    </chapter>
    <chapter
        xml:id="chap.using-cache">
        <title>Using the JpGraph cache system</title>
        <para>To reduce load on the web server JpGraph implements an advanced caching system which
            avoids the burden of always having to run the full image script. The library supports
            two primary ways of significantly increase performance, using the built in cache system
            described in this section and the use of a PHP accelerator described in <xref
                xlink:href="#chap.php-accelerator"/></para>
        <para>Depending on the complexity of the image script, for example if it is doing several DB
            lookups, the use of the library cache system (which will avoid running the graph scripts
            completely if possible) can make a for very drastic performance increase.</para>
        <para><xref xlink:href="#fig.cache-overview"/>shows an overview of the cache system in the library.</para>
        <para>
            <figure
                xml:id="fig.cache-overview">
                <title>Library cache principle</title>
                <mediaobject>
                    <imageobject><imagedata scale="60"
                            fileref="images/cache_principles.png"/></imageobject>
                </mediaobject>
            </figure>
        </para>
        <para>The rationale behind this is the observation that very few graphs are really
            real-time, i.e. needs to be updated absolutely every time the graphing script is called.
            For many graphs in a WEB-environment one can often get good precision by restricting the
            graphs to only be updated, say, a few times each day. Of course, if truly live data is
            what is needed then the cache system can not be used since then, by the nature of live
            data, the graph script must be called at each instance to get the latest available data,
            most probably from a database.</para>
        <sect1>
            <title>Enabling the library cache system</title>
            <para>The enabling and disabling of the cache system is controlled by three defines in
                    <filename>jpg-config.php</filename></para>
            <para>
                <orderedlist>
                    <listitem>
                        <para><code>DEFINE("USE_CACHE",true)</code></para>
                    </listitem>
                    <listitem>
                        <para><code>DEFINE("READ_CACHE",true)</code></para>
                    </listitem>
                    <listitem>
                        <para><code>DEFINE("CACHE_DIR","/tmp/jpgraph_cache/")</code></para>
                    </listitem>
                </orderedlist>
            </para>
            <para>The first of these, <code>USE_CACHE</code>, is the master-switch which must be set
                to true to enable the caching system. </para>
            <para>The second switch, <code>READ_CACHE</code> very seldom needs to be changed. This
                second switch basically tells whether or not JpGraph should ever look in the cache.
                Setting this to false and the master-switch to true would then always generate a new
                updated image file in the cache and this new image would be send back to the
                browser. The main use for this (admittedly) strange setting is if you like to have
                the side effect of the script that a fresh image is always stored in the cache
                directory. </para>
            <para>The third define is not really a switch but a directory specification that tells
                the library what directory to use as the cache directory (where the cached images
                are stored). </para>
            <para>The cache directory (<code>CACHE_DIR</code>) can be set to an arbitrary directory
                but the important thing to keep in mind is that the cache directory must be read and
                writable for the process running PHP. </para>
            <para>
                <note>
                    <para>The directory name given should be an absolute directory path and <emphasis
                            role="bold">not</emphasis> a file path relative to the document
                        root.</para>
                </note>
            </para>
        </sect1>
        <sect1>
            <title>Permission settings for the cache files</title>
            <para><emphasis
                    role="bold"><emphasis
                        role="italic">Note: This section is only applicable to a Unix derivate
                        system which have the concepts of group and file
                    ownership.</emphasis></emphasis></para>
            <para>There are two additional settings that will allow the control of the group and
                file permission settings</para>
            <para>
                <orderedlist>
                    <listitem>
                        <para><code>DEFINE('CACHE_FILE_GROUP','www')</code></para>
                    </listitem>
                    <listitem>
                        <para><code>DEFINE('CACHE_FILE_MOD',0664)</code></para>
                    </listitem>
                </orderedlist>
            </para>
            <para>The <code>CACHE_FILE_GROUP</code> specifies what group should be set on the cached
                image file. If this is left empty then the group will be the same as the process
                running PHP.</para>
            <para>The <code>CACHE_FILE_MOD</code> specifies the file permissions for the image file.
                If this is left empty the default permissions used by PHP will be set on the
                file.</para>
            <para>When PHP is run from the command line (using the PHP CLI version) then the file
                permission and group will normally be set to the one of the suer running PHP. Keep
                in mind that normally ordinary users are not allowed to change the group to
                    '<code>www</code>' (the default Apache2 group).</para>
        </sect1>
        <sect1>
            <title>Using the cache in your script</title>
            <para>The principle of the library cache is as follows when it is enabled.</para>
            <para>
                <orderedlist>
                    <listitem>
                        <para>The first time the graph script is called everything will be as usual,
                            the script will run and in the end the script sends back the image to
                            the browser. However if the caching is enabled JpGraph will
                            automatically have stored a copy of the generated image in the cache
                            directory.</para>
                    </listitem>
                    <listitem>
                        <para>When the graph script is executed the next time it checks to see if an
                            image corresponding to this graph script has already been generated and
                            is available in the cache directory.</para>
                    </listitem>
                    <listitem>
                        <para>If the image is available in the cache directory the library check to
                            see how old the image is. If the images is older than a specified limit
                            than it assumes that the image is out dated and runs the graph script as
                            usual and makes sure the newly generated image is stored in the cache
                            directory. Hence replacing the outdated image.</para>
                    </listitem>
                    <listitem>
                        <para>If the image in the cache directory was current (i.e. not too old) it
                            is read and send back to the clients (e.g. Web-browser) without the rest
                            of the graph script being executed.</para>
                    </listitem>
                </orderedlist>
            </para>
            <para>From the above description there are a couple of parameters that should be
                specified, the name to use when the image is stored and the timeout value when the
                image is considered too old, i.e. how long was it since the image was
                generated.</para>
            <para>The first parameter, the filename, can be either manually specified or the library
                can create a filename based on the name of the graph script. </para>
            <para>Both these parameters are specified in the initial <code>Graph()</code> call where
                a new graph instance is created. A basic example of this is shown in <xref
                    xlink:href="#example.auto-cache-filename"/>.</para>
            <para>
                <example
                    xml:id="example.auto-cache-filename">
                    <title>Using an automatic cache filename and a 60min timeout of the cached
                        images.</title>
                    <programlisting>#!cache-intro1.php#</programlisting>
                </example>
            </para>
            <para>The code in <xref
                    xlink:href="#example.auto-cache-filename"/>. will use an automatic filename for
                the cached image and a make the image valid for 60 minutes. This means that if the
                script is called again, within 60minutes, it will return the image just after the
                initial <code>Graph()</code> call and not execute any more lines of code in the
                script.</para>
            <para>For basic usage this is all that is necessary, enable the cache in the settings
                and supply a filename and a timeout value. The rest of the logic is handled by the
                library.</para>
            <para>
                <tip>
                    <para>If you want the timeout value to be "forever" then you can specify a
                            "<code>0</code>" as the timeout value (or leave the parameter blank). To
                        regenerate the image you will have to manually remove the image files from
                        the cache. This removal could for example be handled by a nightly
                        cron-job.</para>
                </tip>
            </para>
            <para>There is however one caveat which must be understood when using the above
                construction. The image/graph store in the cached file will be returned to the
                browser as a side effect of the initial <code>$graph = new Graph()</code>. This also
                means that: </para>
            <para><emphasis
                    role="bold">No lines after the initial Graph() call will be executed in the
                    image script in case the image exists in the cache directory.</emphasis></para>
            <para>This is the expected behaviour since this means that no unnecessary code will be
                executed in the graph script in case the image has been found in the image
                cache.</para>
            <para>However, for the case where some more control of exactly how a cached image is
                sent back it is necessary to add some complexity by doing things less automatically.
                This gives greater control but also is slightly more complex and is described in the
                next section.</para>
            <sect2>
                <title>Manually controlling the cached image</title>
                <para>
                    <note>
                        <para>These utility functions were added in <emphasis
                                role="bold">v3.0.5</emphasis> of the library. It is still possible
                            to do this in previous versions but then some more code is needed to
                            duplicate what these methods does. If this feature is wanted then it is
                            strongly advised to upgrade to this or later version.</para>
                    </note>
                </para>
                <para>There are two parts to doing this manually.</para>
                <para>
                    <orderedlist>
                        <listitem>
                            <para>Check if the cached image exists in the cache and is valid (i.e.
                                not too old)</para>
                        </listitem>
                        <listitem>
                            <para>Stream the cached image file back to the browser in that
                                case</para>
                        </listitem>
                    </orderedlist>
                </para>
                <para>If the cached image is not valid then we just need to construct the graph as
                    usual and it will be stored in the cache automatically.</para>
                <para>The following code example shows how this is done in principle in a graph
                    script where we use automatic naming i.e. the cached file name will get a name
                    based on the script name. This is done with the library utility function
                        <code>GenImgName()</code> which constructs a suitable image name from the
                    script name and with a proper image compression format (i.e png, jpg or
                    gif).</para>
                <para>
                    <programlisting>&lt;?php
$width = ...;
$height = ...;
$cachefilename = GenImgName();
$graph = new Graph($width,$height);

// Check if the cache file exists and is valid
$valid = $graph->cache->IsValid($cachefilename);

if( $valid ) {
    // The cached file is valid and we can now do any necessary
    // processing and then send it back to the client
    doSomeProcessingIfNecessary();

    $graph->cache->StreamImgFile($graph->img,$cachefilename);

} else {
    
    // The cache file is not valid or does not exists so we
    // must construct the graph as normal

    // Tell the graph that we want to cache this image
    $timeout = ...;
    $graph->SetupCache($cachefilename,$timeout);

    // The remainder of a normal graph script

    ...

    // .. and send back the image as usual (this will also store
    // a copy of the image in the cache directory)
    $graph->Stroke();
}
    </programlisting>
                </para>
            </sect2>
        </sect1>
        <sect1
            xml:id="sect1.cache-csim">
            <title>Using the cache with Client Side Image Maps (CSIM)</title>
            <para>(See <xref
                    xlink:href="#chap.using-csim"/> for a full description on the usage of CSIM
                together with the library)</para>
            <para>You can also use the cache system for images that uses image maps (CSIM) as well.
                The cache system interface is slightly different in this case since the cache needs
                to store both the cached image and the cached image-map. It also needs to change due
                to the added complexity with CSIM scripts not sending back an image but rather a
                pre-formatted HTML page. The two major differences from the non-CSIM cache
                is:</para>
            <para>
                <orderedlist>
                    <listitem>
                        <para>The cached version will <emphasis
                                role="bold">not</emphasis> be stored in the previous defined cache
                            directory. It uses a different cache directory.</para>
                    </listitem>
                    <listitem>
                        <para>The script that want to make use of the cache system together with
                            CSIM must call an extra method, <code>CheckCSIMCache()</code>, to check
                            the cache.</para>
                    </listitem>
                </orderedlist>
            </para>
            <para>
                <note>
                    <para>Please remember that when using CSIM you must end your script with a call
                        to <code>Graph::StrokeCSIM()</code> method instead of the
                            <code>Graph::Stroke()</code> used for non-CSIM. </para>
                </note>
            </para>
            <para>To use the cache with CSIM you have to call the
                    <code>Graph::CheckCSIMCache()</code>. As with the caching for non-CSIM you have
                to supply a name to be used for the cached version (it can be manually or automatic)
                as well as an optional timeout value. The default timeout value if nothing else is
                specified is 60 minutes.</para>
            <para>The name argument requires some more explanations. The file name must be specified
                as a relative name. </para>
            <para>For example "<filename>myimage</filename>" or perhaps
                    "<filename>firstpage/image3</filename>". </para>
            <para>The reason for his is that a script that uses CSIM does not send back an image.
                Instad it sends back a HTML page which includes the image map coordinates and has an
                included "<markup>&lt;img href=" ... "></markup>" tag which references the image
                script recursively in normal cases but if the image is found in the cache this
                reference will be to a static image instead.</para>
            <para>Depending on the installation of the library this will now end up in the directory
                specified in the <code>CSIMCACHE_DIR</code> define. This must also be a directory
                accessible by the normal HTTP/PHP process. By default, if nothing else is specified,
                a directory called "<filename>csimcache</filename>" will be created in the same
                directory as the image script itself.</para>
            <para>The default value has the drawback that the directory from where the script is
                executed must also be writable by the process running PHP. Best practice here is to
                keep the number of writable directory for PHP down to a minimum and re-use the same
                directory as is used for the standard cache. </para>
            <para>This however, requires that the PHP and HTTP setup is such that the cache
                directory is also accessible by the HTTP server from the htdocs root.</para>
            <para>The <code>CheckCSIMCache()</code> method checks the cache for an existing cached
                version and if found it returns it and halts execution of the script. So, this call
                should be the first call after the creation of the core graph instance, i.e.
                    <code>$graph = Graph($width,$height)</code> and before any heavy work is done to
                create the image so that no unnecessary work is done in case a cached image + image
                map is found.</para>
            <para>The general structure of a script that uses CSIM and cache should follow the
                template shown in </para>
            <para>
                <example>
                    <title>General structure for a CSIM script that uses CSIM</title>
                    <programlisting>#!csim-cache-template.php#</programlisting>
                </example>
            </para>
            <para>Please note that it is not necessary to pass any argument to the final call of
                StrokeCSIM()</para>
            <para>
                <note>
                    <para>The CSIM caching works by storing two files in the cache directory. One
                        file being the image and the other file being the corresponding image map as
                        a pure HTML file. The HTML file will reference the static image.</para>
                </note>
            </para>
        </sect1>
    </chapter>
    <chapter
        xml:id="chap.using-csim">
        <title>Using CSIM (Client side image maps)</title>
        <para>Image maps makes it possible to create images with "active" areas that will react for
            a mouse-click. It is then up to the designer to decide what actions should be taken.
            Image map is often used to create drill-down charts where it is possible to dynamically
            zoom into an image. Image maps is part of the HTML standard.</para>
        <para>There are actually two types of images maps, client and server-side. This refers to
            where the actual processing of the image click happens. Without doubt the best (and most
            commonly used) type is the client side. This is also what the library supports. In the
            remainder of this manual this will be referred to as <emphasis
                role="bold">CSIM</emphasis>, <emphasis
                role="bold">C</emphasis>lient <emphasis
                role="bold">S</emphasis>ide <emphasis
                role="bold">I</emphasis>mage <emphasis
                role="bold">M</emphasis>aps.</para>
        <sect1>
            <title>The principles</title>
            <para>Image maps works so that each hotspot area in the graph that should be used must
                have an associated URL. When the user clicks somewhere in that particular hotspot
                area the browser will open the specified URL. Typical hotspot areas in the graphs
                are</para>
            <para>
                <orderedlist>
                    <listitem>
                        <para>Texts, for example titles</para>
                    </listitem>
                    <listitem>
                        <para>Markers in line graphs</para>
                    </listitem>
                    <listitem>
                        <para>Slices in pie graphs</para>
                    </listitem>
                    <listitem>
                        <para>Legends</para>
                    </listitem>
                    <listitem>
                        <para>Bars in barplots</para>
                    </listitem>
                    <listitem>
                        <para>etc.</para>
                    </listitem>
                </orderedlist>
            </para>
            <para>The way the CSIM HTML standard works is that the HTML page must have a section
                with coordinates that defines the various hotspots together with the associated URL
                that should be called. Each section of coordinates are connected to a specific image
                that is included with a standard <markup>&lt;img></markup> by a common id. This will
                now add some complexity since the library must return an HTML page for the
                coordinates and not image data as normal for the library. How this is done is the
                topic of the next section.</para>
            <para>A number of examples of CSIM graphs are included in the
                    <filename>Examples/</filename> directory. Some of the available examples are
                listed in <xref
                    xlink:href="#tab.csim-examples-name"/></para>
            <para>
                <table
                    frame="none"
                    xml:id="tab.csim-examples-name">
                    <title>CSIM Examples (in Examples/ directory)</title>
                    <tgroup
                        cols="2">
                        <colspec
                            colname="c1"
                            colnum="1"/>
                        <colspec
                            colname="c2"
                            colnum="2"/>
                        <thead>
                            <row>
                                <entry
                                    namest="c1"
                                    nameend="c2">CSIM Examples (in Examples/ directory)</entry>
                            </row>
                        </thead>
                        <tbody>
                            <row>
                                <entry><filename>bar_csimex1.php</filename></entry>
                                <entry><filename>bar_csimex2.php</filename></entry>
                            </row>
                            <row>
                                <entry><filename>bar_csimex3.php</filename></entry>
                                <entry><filename>barline_csimex1.php</filename></entry>
                            </row>
                            <row>
                                <entry><filename>barlinefreq_csimex1.php</filename></entry>
                                <entry><filename>boxstockcsimex1.php</filename></entry>
                            </row>
                            <row>
                                <entry><filename>ganttcsimex01.php</filename></entry>
                                <entry><filename>ganttcsimex02.php</filename></entry>
                            </row>
                            <row>
                                <entry><filename>imgmarkercsimex1.php</filename></entry>
                                <entry><filename>pie3d_csimex1.php</filename></entry>
                            </row>
                            <row>
                                <entry><filename>piec_csimex1.php</filename></entry>
                                <entry><filename>pie_csimex1.php</filename></entry>
                            </row>
                            <row>
                                <entry><filename>scatter_csimex1.php</filename></entry>
                                <entry><filename>titlecsimex01.php</filename></entry>
                            </row>
                        </tbody>
                    </tgroup>
                </table>
            </para>
            <para>In order to easily access all of these examples it is possible to call the
                    <filename>testsuit.php</filename> example with an additional argument
                    "<code>t=2</code>". By following the link
                "<filename>testsuit.php?t=2</filename>" a separate window will open with all the
                possible CSIM examples.</para>
        </sect1>
        <sect1>
            <title>The basic structure of an image map script</title>
            <para>The basic structure for a HTML page using client side image maps will have the
                following layout</para>
            <para>
                <screen>// Image map specification with name "mapname"
&lt;MAP NAME=...>
... specification ...
&lt;/MAP>

// Image tag
&lt;img src="..." ISMAP USEMAP="mapname">
</screen>
            </para>
            <para>This poses an interesting question. Since we normally call the graphing script
                directly in the <markup>&lt;img></markup> tag how do we get hold of the image map
                (which is available only in the image script) in this "HTML wrapper" script?</para>
            <para>In JpGraph there is actually two ways of solving this.</para>
            <para>
                <orderedlist>
                    <listitem>
                        <para>Use the preferred "builtin" way using the modified
                                <code>Stroke()</code> method <code>StrokeCSIM()</code> instead of
                            the standard <code>Graph::Stroke()</code> method.</para>
                    </listitem>
                    <listitem>
                        <para>Directly use the <code>Graph::GetHTMLImageMap()</code> which gives you
                            fine control at the expense of more complex coding. This is necessary if
                            several image map graphs are needed on the same page.</para>
                    </listitem>
                </orderedlist>
            </para>
            <para>The first (and preferred) way modifies the stroke method so that instead of
                returning an image (like the standard <code>Stroke()</code> method)
                    <code>StrokeCSIM()</code> actually returns an HTML page containing both the
                image map specification and the correct<code> &lt;IMG></code> tag.</para>
            <para>This means that it is necessary to treat an image map returning image script
                differently from a non-CSIM image script, for example it is not posible to use it
                directly as the target for the "<code>src</code>" attribute of the
                    <markup>&lt;IMG></markup> tag since it sends back a HTML page containing both an
                image tag together with an image map.</para>
        </sect1>
        <sect1>
            <title>Specifying targets for image map plots</title>
            <para>To turn a standard image script into a CSIM script the first thing needed to do is
                to supply the appropriate URL targets for the hotspots in the image. What the
                hotspots represent depends on the type of plot. CSIM is supported by all graph
                types. </para>
            <para>To specify a URI link for each hotspot the <code>SetCSIMTargets()</code> method is
                used on the graph object that should be given a hotspot.</para>
            <para>There are two arguments to this method</para>
            <para>
                <orderedlist>
                    <listitem>
                        <para><code>$aTargets</code>, an array of valid URL targets. One URL per hot
                            spot, for example if you have a 10 values bar plot you need 10 URLs. If
                            the <code>SetCSIMTarget()</code> is applied to, for example, a text then
                            only one URL target should be specified.</para>
                    </listitem>
                    <listitem>
                        <para><code>$aAlts</code>, an array of valid alt-texts. Many browsers (but
                            not all) will show this text string if the mouse hovers over a
                            hotspot.</para>
                    </listitem>
                </orderedlist>
            </para>
            <sect2>
                <title>Creating popup-windows as targets for CSIM</title>
                <para>URL targets specified will be opened by the browser as usual, i.e. it will
                    replace the current HTML page. Another common usage pattern is to opena popup
                    window, perhaps with a zoomed version of a graph. This can be done by adding
                    some javascript in the target URL. If the URL, for example, is specified
                    as</para>
                <para>
                    <screen>$target = "..."; 
$targetURL = "javascript:window.open('$target?id=%d','_new','width=500,height=300');void(0)"</screen>
                </para>
                <para>clicking on a target will now open a separate window with the specified width
                    and height. The <code>$target</code> variable must be set to the wanted
                    URL.</para>
            </sect2>
        </sect1>
        <sect1>
            <title>Using StrokeCSIM()</title>
            <para>The simplest way of creating a creating a CSIM image is with the
                    <code>StrokeCSIM()</code> method. As mentioned before this method actually
                returns a (small) HTML page containing both the image-tag as well as the image map
                specification. Hence it is not possible to use a script that ends with this method
                in a standard image-tags src property.</para>
            <para>There are two ways to create CSIM (or get hold of) the image maps</para>
            <orderedlist>
                <listitem>
                    <para>Use the CSIM image script as the target in a standard anchor reference,
                        for example </para>
                    <para>
                        <screen>&lt;a href="mycsimscript.html"> </screen>
                    </para>
                    <para>This has the drawback that the image page will only contain the image and
                        nothing else.</para>
                </listitem>
                <listitem>
                    <para>The other way will allow the image script to be included in an arbitrary
                        HTML page by just including the image script at the wanted place in the HTML
                        page using any of the standard "include" php statement. For example </para>
                    <para>
                        <screen>&lt;h2> This is an CSIM image &lt;/h2>

&lt;?php include "mycsimscript.php" ?></screen>
                    </para>
                </listitem>
            </orderedlist>
            <para>Note: If there are several CSIM images on the same page it is necessary to use
                "include_once" in the scripts for the inclusion of
                "<filename>jpgraph.php</filename>" and the other jpgraph library files since the
                files will be included multiple times on the same page and one or more "<emphasis
                    role="italic">Already defined error</emphasis>" will be displayed.</para>
            <para>The process to replace <code>Stroke()</code> with <code>StrokeCSIM()</code> is
                strait forward. Replace all existing calls to <code>Stroke()</code> with the
                equivalent calls to <code>StrokeCSIM()</code>.</para>
            <sect2>
                <title>Optional argument to StrokeCSIM()</title>
                <para>Once difference compared with Stroke() is that if a filename is supplied to
                    the <code>StrokeCSIM()</code> method it does not specify a file to write an
                    image to as is the case with Stroke(). The signature for the method is</para>
                <para>
                    <screen>StrokeCSIM($aScriptName='auto', $aCSIMName='', $aBorder=0)</screen>
                </para>
                <para>The first (optional) argument is the name of the actual image script file
                    including the extension. So for example if the image script is called
                        "<filename>mycsimscript.php</filename>" the call should be </para>
                <para>
                    <screen> $graph -> StrokeCSIM ( 'mycsimscript.php' ) </screen>
                </para>
                <para>By using the predefined name 'auto'. This will be done automatically.</para>
                <para>
                    <note>
                        <para>Why does the script name need to be used as the first parameter? The
                            reason is that in the creation of the HTML page which is sent back we
                            need to refer to the script in the image tag. In older versions of PHP
                            there where no 100% way of getting hold of the actual script name in all
                            circumstances and it was then necessary to specify it here. In PHP5 (and
                            newer version of PHP4) this is no longer a problem but this parameter is
                            still kept for backward compatibility.</para>
                    </note>
                </para>
                <para>The other arguments to <code>StrokeCSIM()</code> are optional as well. The
                    second argument specifies the id that connect the map with the corresponding
                    image. Please note that if several CSIM images are used in the same HTML page it
                    is necessary to specify the image map name as the second parameter since all
                    image maps must be unique to properly match each image map against each image.
                    Please consult the class reference <code>StrokeCSIM()</code> for more
                    details.</para>
                <para>The final argument specifies whether the image should have border or
                    not.</para>
            </sect2>
            <sect2>
                <title>How does StrokeCSIM() work?</title>
                <para>Knowledge of the exact technical details of the way <code>StrokeCSIM()</code>
                    works is probably not needed by many people but for completeness we outline
                    those details in this short section.</para>
                <para>The fundamental issue we have to solve is that we must be able to call the
                    image script in two modes. When the user includes the image script the
                        <code>StrokeCSIM()</code> method should return the HTML page but when the
                    image script is later called directly in the image tag it must not return an
                    HTML page but rather the actual image.</para>
                <para>The way this is solved is by using one <code>GET</code> argument which is
                    passed on automatically when we use the image script name in the
                        <markup>&lt;img></markup>-tag.</para>
                <para>A look at the generated HTML from StrokeCSIM() will make this clear. In <xref
                        xlink:href="#fig.generated-csim-html-code"/> the resulting HTML code after
                    running the example script <filename>bar_csimex1.php</filename> is shown. The
                    argument to the src-property of the image tag is not simply the script name but
                    the script name with a additional argument, <code>?_jpg_csimd=1</code>. This
                    argument is passed on to the library which then will run the script again but
                    this time only generate the image and not the HTML. (In the JpGraph internal
                    code this pre-defined argument is checked for and if it exists the image is send
                    back and not the HTML page.)</para>
                <para>
                    <note>
                        <para>The actual string name of this parameter is defined by a
                                <code>DEFINE</code> statement in JpGraph,
                            <code>_CSIM_DISPLAY</code>.</para>
                    </note>
                </para>
                <para>
                    <figure
                        xml:id="fig.generated-csim-html-code">
                        <title>Example of generated HTML code for StrokeCSIM()</title>
                        <screen>&lt;map name="__mapname1828__" id="__mapname1828__" >
&lt;area shape="poly" coords="74, 210, 74, 165, 92, 165, 92, 210"  href="bar_clsmex1.php#1" title="val=12" alt="val=12"  />
&lt;area shape="poly" coords="118, 210, 118, 112, 136, 112, 136, 210"  href="bar_clsmex1.php#2" title="val=26" alt="val=26"  />
&lt;area shape="poly" coords="162, 210, 162, 176, 180, 176, 180, 210"  href="bar_clsmex1.php#3" title="val=9" alt="val=9"  />
&lt;area shape="poly" coords="206, 210, 206, 146, 224, 146, 224, 210"  href="bar_clsmex1.php#4" title="val=17" alt="val=17"  />
&lt;area shape="poly" coords="250, 210, 250, 93, 268, 93, 268, 210"  href="bar_clsmex1.php#5" title="val=31" alt="val=31"  />
&lt;/map>
&lt;img src="bar_csimex1.php?_jpg_csimd=1" ismap="ismap" usemap="#__mapname1828__" border="0" width="310" height="250" alt="" />
</screen>
                    </figure>
                </para>
                <para>
                    <note>
                        <para>As the astute reader has come to realize CSIM scripts has a
                            performance impact in that each script has to be run twice. Once to get
                            hold of all the coordinates and generate the image and a second time via
                            the &lt;img> tag in generated HTML. The library is intelligent enough to
                            minimize the code to run so that it only runs what is absolutely
                            necessary. This means that roughly 75% has to be run which yields a
                            total overhead of around 1.75 times when generating a CSIM image.</para>
                    </note>
                </para>
            </sect2>
            <sect2>
                <title>Image maps and the cache system</title>
                <para>For version 1.9 and later the cache system has been extended to include the
                    CSIM maps as well. For each CSIM graph two files are stored in the cache, the
                    image file itself as well as the wrapper HTML with the actual image map. </para>
            </sect2>
        </sect1>
        <sect1>
            <title>Getting hold of the image map</title>
            <para>There are at least two cases where the basic StrokeCSIM() method will not work.
                Basically this is limited to only showing the graph in one HTML page and nothing
                more. So the cases where this needs to be handled differently are</para>
            <para>
                <orderedlist>
                    <listitem>
                        <para>In the case where you want to store the image on disk and later use it
                            in an <markup>img</markup>-tag you need to get hold of the image map.
                        </para>
                    </listitem>
                    <listitem>
                        <para>In order to include multiple CSIM images ona a WEB-page. (This is not
                            entirely true though, it is possible to include several CSIM graph
                            images with the use of the <markup>&lt;iframe></markup> tag. This in
                            effect creates it's own WEB page within the WEB page but we will not
                            discuss this further here.</para>
                    </listitem>
                </orderedlist>
            </para>
            <para>To get hold of the image map the function <code>Graph::GetHTMLImageMap()</code>
                should be used. This returns the coordinates for the hotsposts</para>
            <para>An example of the use of this is shown below. With these lines the image will be
                written to a file. The script then returns a HTML page which contains the Client
                side image map and an img-tag which will retrieve the previously stored file.</para>
            <para>
                <programlisting>$graph -> Stroke ( "/usr/local/httpd/htdocs/img/image001.png" );

echo  $graph -> GetHTMLImageMap ( "myimagemap001" );
echo  "&lt;img src=\"img/image001.png\" ISMAP USEMAP=\"#myimagemap001\" border=0>" ; 
</programlisting>
            </para>
        </sect1>
        <sect1>
            <title>Mixing several CSIM images in an HTML page with text</title>
            <para>As was mentioned above using <code>StrokeCSIM()</code> is very simple but it has
                the drawback that it returns a single HTML page without any possibilities to add
                additional text which makes its use fairly limited in real life situation where the
                graph is part of a complex WEB-page. In this section we will discuss some best
                practice to do this.</para>
            <para>In principle there are two ways to do this</para>
            <para>
                <orderedlist>
                    <listitem>
                        <para>Store both the image map and the image in files which are later read
                            back in the HTML page. This has the advantage of being simple but the
                            drawback that it increases the processing time since writing and reading
                            from a file takes time.</para>
                    </listitem>
                    <listitem>
                        <para>Avoiding the use of temporary file by mimicking the way
                                <code>StrokeCSIM()</code> works and od the steps
                                <code>StrokeCSIM()</code> does internally but in the script
                            directly. In the remainder of this section we will show how this can be
                            setup. That part will also introduce the method
                                <code>StrokeCSIMImage()</code> which is key to include CSIM graphs
                            in HTML pages.</para>
                    </listitem>
                </orderedlist>
            </para>
            <caution>
                <para>Some of the described methods in this section was added in version 2.5 of the
                    library. In earlier versions more of this has to be done manually.</para>
            </caution>
            <sect2
                xml:id="sec2.adding-csim-in-html">
                <title>Adding one CSIM graph in a HTML page</title>
                <para>The library has been designed to make this as painless as possible but due to
                    the way CSIM works there are some manual work that cannot be avoided. We will
                    start slowly and in detail walk through an example where we include one CSIM
                    graph in an arbitrary HTML page. There are a few things to keep in mind, the
                    rest will be taken care of automatically by the library</para>
                <para>
                    <orderedlist>
                        <listitem>
                            <para>In the HTML page the CSIM map must be semi-manually included. (It
                                doesn't matter where)</para>
                        </listitem>
                        <listitem>
                            <para>The <markup>&lt;img> </markup>tag for rendering the image must be
                                semi-manually created</para>
                        </listitem>
                        <listitem>
                            <para>The original graph script needs a minor augmentation since it
                                should no longer end by calling <code>StrokeCSIM()</code></para>
                        </listitem>
                        <listitem>
                            <para>Some care needs to be taken to specify what the URL:s to be called
                                should be</para>
                        </listitem>
                    </orderedlist>
                </para>
                <para>The library provides suitable functions for step 1 &amp; 2 above so the only
                    thing that needs to be done in the HTML page is calling these functions at
                    suitable places. In principle the HTML page should have the structure shown in <xref
                        xlink:href="#ex.csim-html-ex1"/></para>
                <para>
                    <example
                        xml:id="ex.csim-html-ex1">
                        <title>Principles of including CSIM graph in a HTML page</title>
                        <programlisting>&lt;html>
&lt;body>
&lt;?php
// The name of the graph script file (change as needed!)
$_graphfilename = 'mycsimgraph.php';

// This is the filename of this HTML file
global $_wrapperfilename;
$_wrapperfilename = basename (__FILE__);

// Create a random mapname used to connect the image map with the image
$_mapname = '__mapname'.rand(0,1000000).'__';

// This is the actual graph script
require_once ($_graphfilename);

// Get hold of the image map to include it in the HTML page
$imgmap = $graph->GetHTMLImageMap($_mapname);
echo $imgmap;
?>

&lt;p>Some arbitrary HTML text .... &lt;/p>

&lt;?php
// We now create the &lt;img> tag
$imgtag = $graph->GetCSIMImgHTML($_mapname,$_graphfilename);
echo $imgtag;
?>

&lt;/body>
&lt;/html></programlisting>
                    </example>
                </para>
                <para>Before we discuss the HTML code in detail lets first show what augmentation is
                    needed in the graph script.</para>
                <para>Normally the graph script will end with a call to either
                        <code>Graph::Stroke()</code> or <code>Graph::StrokeCSIM()</code>. However,
                    with CSIM style graph the complication is that we need to call the script twice.
                    Once to get the image map and once (in the final &lt;img> tag) to actually
                    generate the image. In order to separate these two cases we make use of a URL
                    argument which will be used as a flag so that we know how to behave in the graph
                    script. In conjunction with HTML skeleton shown in <xref
                        xlink:href="#ex.csim-html-ex1"/> we need to change the graph script so that
                    it instead uses the method <code>Graph::StrokeCSIMImage()</code> so that the
                    last line will be changed to</para>
                <para>
                    <programlisting>...
$graph->StrokeCSIMImage();
?></programlisting>
                </para>
                <para>This method will only stroke the image when the "secret" flag is passed as a
                    URL argument (which will be added automatically when the &lt;img> tag is
                    constructed in the call to <code>GetCSIMImgHTML()</code> . This means that the
                    first time this function gets called when we do the initial
                        <code>require_once()</code> in the top of the HTML page this method will do
                    nothing, which is exactly what we want since we only want to include the graph
                    script in order to be able to do the call to <code>GetHTMLImageMap()</code>
                    later down in the script.</para>
                <para>We are now in position to discuss the HTML script above.</para>
                <para>
                    <variablelist>
                        <varlistentry>
                            <term>Line 1-2</term>
                            <listitem>
                                <para>This is the standard HTML opening tags (by choice we keep this
                                    very simple and sloppy in these example.)</para>
                            </listitem>
                        </varlistentry>
                        <varlistentry>
                            <term>Line 3-20</term>
                            <listitem>
                                <para>This is where we include the graph script. In addition we must
                                    also create a map name that will be used to connect an image map
                                    with the <markup>&lt;img></markup> tag. We have chosen to create
                                    a random name since the actual name is not significant. The only
                                    criteria is that the name must be unique if there are multiple
                                    maps in the same HTML page.</para>
                                <para>In addition we also record the name of the actual HTML page in
                                    the variable "<code>$wrapperfilename</code>". This is so we can
                                    potentially use it as a target in the image script. We could
                                    then have targets that redisplays the same page but with
                                    potential additional or changed URL argument.</para>
                            </listitem>
                        </varlistentry>
                        <varlistentry>
                            <term>Line 21-22</term>
                            <listitem>
                                <para>This is just an illustration that it is possible to add
                                    arbitrary HTML markups and text on the page.</para>
                            </listitem>
                        </varlistentry>
                        <varlistentry>
                            <term>Line 23-27</term>
                            <listitem>
                                <para>This is where we generate the needed &lt;img> tag that should
                                    be included in the page. It is illustrative to view how the
                                    &lt;img> tag actually looks.</para>
                                <para>
                                    <programlisting>&lt;img src="mycsimgraph.php?_jpg_csimd=1" ismap="ismap" 
usemap="#__mapname987066__" border="0" width="400" height="250" alt="" /></programlisting>
                                </para>
                                <para>The name of the image is the specified graph name (which was
                                    given as the second argument). As can bee seen a URL argument
                                        "<code>flag _jpg_csimd=2</code>" has been added. This is the
                                    "secret" flag that instructs <code>StrokeCSIMImage()</code> to
                                    actually send back the image. The second thing to notice is the
                                    map name. This is the random name we constructed that is used to
                                    connect to the map we wanted to use with this image.</para>
                            </listitem>
                        </varlistentry>
                        <varlistentry>
                            <term>Line 28-30</term>
                            <listitem>
                                <para>The closing HTML tags</para>
                            </listitem>
                        </varlistentry>
                    </variablelist>
                </para>
                <para>What remains is to discuss how the actual CSIM targets in the graph script
                    should be constructed. Again there are some choices to be made on what should
                    happen when a user clicks on the gaph.</para>
                <para>
                    <orderedlist>
                        <listitem>
                            <para>Clicking on a graph should open a "popup" window</para>
                        </listitem>
                        <listitem>
                            <para>Clicking on a graph should open the same HTML page but with some
                                additional URL arguments</para>
                        </listitem>
                        <listitem>
                            <para>Clicking on a graph should open a fresh page in the browser</para>
                        </listitem>
                        <listitem>
                            <para>Clicking on the graph should open in an existing browser
                                window</para>
                        </listitem>
                    </orderedlist>
                </para>
                <para>Earlier in this chapter we have shown how to handle case 1 so in the following
                    we will concentrate on cases 2-4. Before we start we need to discuss the third,
                    not yet mentioned, argument to the method <code>SetCSIMTargets()</code>. To
                    remind ourself this method is used on the various objects in a graph that can
                    act as hotspots. The full signature for this method is</para>
                <para>
                    <programlisting>SetCSIMTargets($aURLTargets,$aAltTexts,$aWinTargets);</programlisting>
                </para>
                <para>The first argument specifies the URLs. Depending on the actual object this is
                    either a string or an array of strings.</para>
                <para>The second argument specified the HTML "alt" texts. In most browser this is
                    shown as a popup text if the mouse pointer hovers over a hotspot area.</para>
                <para>The final argument specifies the URL target window (where the link should
                    open). Most browser recognizes a few special targets here<itemizedlist>
                        <listitem>
                            <para>"_blank" . This will open the URL in a new browser window</para>
                        </listitem>
                        <listitem>
                            <para>"_top". Will break out of a frameset and display the target window
                                at top </para>
                        </listitem>
                        <listitem>
                            <para>"" (empty). Will open the target in the current window</para>
                        </listitem>
                        <listitem>
                            <para>"namedWindow". Will open the target in the named window</para>
                        </listitem>
                    </itemizedlist></para>
                <para>In the discussions below we will assume that the graph is a basic barplot so
                    the URLs we specify are connected to each individual bar in the plot and are
                    specified with a call similar to</para>
                <para>
                    <programlisting>$bplot->SetCSIMTargets($targets,$altnames,$wintargets)</programlisting>
                </para>
                <para/>
                <para><emphasis
                        role="bold">Case 2: Opening the same page but with some different URL
                        arguments.</emphasis></para>
                <para>To do this we make use of the name of the HTML wrapper file we stored in
                        <code>$_wrapperfilename</code> . We can then construct the targets as shown
                    in <xref
                        xlink:href="#ex.csim-targ-same-window"/></para>
                <para>
                    <example
                        xml:id="ex.csim-targ-same-window">
                        <title>Creating CSIM URL targets to open in same browser window</title>
                        <programlisting>&lt;?php
...
global $_wrapperfilename;
$n = .. ; // Number of bars
$targ = array(), $alt = array(); $wtarg = array();
for( $i=0; $i &lt; $n; ++$i ) {
    $urlarg = urlencode( ... );
    $targ[] = $_wrapperfilename.'?'.$urlarg;
    $alt[] = 'val=%d';
    $wtarg[] = '';
}
$bplot->SetCSIMTargets($targ,$alt,$wtarg);
...
?></programlisting>
                    </example>
                </para>
                <para>
                    <caution>
                        <para>Remember to not include the "&amp;" or the "=" used when constructing
                            the URL argument in the call to <code>urlencode()</code>. Otherwise they
                            will become part of the data and not separators in the URL argument
                            string.</para>
                    </caution>
                </para>
                <para><emphasis
                        role="bold">Case 3: Open a fresh page in the browser</emphasis></para>
                <para>The following example opens the plain browser script in a fresh window. In
                    order to get hold of the script name we use the predefined PHP constant
                        <code>__FILE__</code> . The target can of course be changed to any
                    URL.</para>
                <para>
                    <example
                        xml:id="ex.csim-targ-fresh-window">
                        <title>Creating CSIM URL targets to open in a fresh window</title>
                        <programlisting>&lt;?php
...
$n = .. ; // Number of bars
$targ = array(), $alt = array(); $wtarg = array();
for( $i=0; $i &lt; $n; ++$i ) {
    $urlarg = urlencode( ... );
    $targ[] = __FILE__.'?'.$urlarg;
    $alt[] = 'val=%d';
    $wtarg[] = '_blank';
}
$bplot->SetCSIMTargets($targ,$alt,$wtarg);
...
?></programlisting>
                    </example>
                </para>
                <para><emphasis
                        role="bold">Case 4: Open in an existing window/frame</emphasis></para>
                <para>By modifying the <code>$wtarg[]</code> line in the example above to </para>
                <para>
                    <programlisting>&lt;?php 
$wtarg[] = '';
?></programlisting>
                </para>
                <para>The target will open in the existing window.</para>
                <para>In the "<filename>Example/</filename>" directory you can find the above a
                    fully working script as "<filename>csim_in_html_ex1.php</filename>" (HTML
                    script) and "<filename>csim_in_html_graph_ex1.php</filename>" (Graph
                    script).</para>
            </sect2>
            <sect2>
                <title>Adding multiple CSIM graphs in a HTML page</title>
                <para>Having laid the foundation for inclusion of CSIM graphs in <xref
                        xlink:href="#sec2.adding-csim-in-html"/> it is now a simple exercise to
                    extend this to include multiple CSIM graphs in the same HTML page. The only
                    modifications we have to do is to make sure that:</para>
                <para>
                    <orderedlist>
                        <listitem>
                            <para>Each image map has a unique name</para>
                        </listitem>
                        <listitem>
                            <para>The graph scripts must create unique instances of the main Graph
                                class, i.e. they cannot both have an instance called
                                    "<code>$graph</code>"</para>
                        </listitem>
                        <listitem>
                            <para>Include each graph script in turn and get the corresponding HTML
                                map</para>
                        </listitem>
                        <listitem>
                            <para>Get the proper image tag for each graph</para>
                        </listitem>
                    </orderedlist>
                </para>
                <para>In <xref
                        xlink:href="#ex.csim-html-two-graphs"/> we show a complete HTML script that
                    includes two graphs, one bar (the same as in the previous example) and one Pie
                    graph. For illustrative purposes we use class <code>PieGraphC</code> variant
                    which is a Pie graph with a circular middle. The result of calling this HTML
                    page is shown in ??</para>
                <para>
                    <example
                        xml:id="ex.csim-html-two-graphs">
                        <title>Example of HTML page that includes two Graph CSIM scripts
                                ("<filename>Examples/csim_in_html_ex2.html</filename>")</title>
                        <programlisting>#!csim_in_html_ex2.html#</programlisting>
                    </example>
                </para>
                <para>
                    <figure>
                        <title>Browser window after calling HTML page in <xref
                                xlink:href="#ex.csim-html-two-graphs"/> (Note: The image has been
                            scaled down to better fit this manual.)</title>
                        <mediaobject>
                            <imageobject><imagedata
                                    scale="70"
                                    fileref="images/csim-html-example-page.png"/></imageobject>
                        </mediaobject>
                    </figure>
                </para>
            </sect2>
        </sect1>
    </chapter>
    <chapter
        xml:id="chap.php-accelerator">
        <title>NuSphere PHP accelerator</title>
        <para>
            <caution>
                <para>The NuSphere encoded variant of the library is only included in the JpGraph
                    pro version.</para>
            </caution>
        </para>
        <sect1>
            <title>Introduction and purpose</title>
            <para>One of the best way to increase the performance of large and complex PHP scripts
                is to install one of the available PHP accelerators. JpGraph supports <emphasis
                    role="italic">NuSphere PhpExpress</emphasis> accelerator. In order to take
                advantage of this accelerator you must install the version of the library that is
                encoded for use with the accelerator. This version is included in the Pro-version of
                the library under the directory <filename>src-encoded/</filename>.</para>
            <para>If you have the Pro-version of the library there is really no good reason not to
                use the accelerated version of the library. It will reduce the load on your server
                as well as significantly decrease the run time for graph scripts. In addition it
                will also reduce some of the memory requirements needed since the parsing process
                (translating PHP to bytecode) for the library can be avoided. Furthermore <emphasis
                    role="italic">NuSphere PhPExpress</emphasis> also implements a caching mechanism
                which means that often executed scripts will be kept in memory to avoid re-reading
                them from disk each time they are needed. This applies to both encoded and
                non-encoded script files.</para>
        </sect1>
        <sect1>
            <title>Installing PhpExpress</title>
            <para>NuSphere PhpExpress is a regular PHP extension, which makes it easy to install and
                deploy. You can download PhpExpress freely from </para>
            <para><uri
                    xlink:href="http://www.nusphere.com/products/phpexpress.htm">http://www.nusphere.com/products/phpexpress.htm</uri></para>
            <para>To install <emphasis
                    role="italic">NuSphere PhpExpress</emphasis> do the following: </para>
            <para>
                <orderedlist>
                    <listitem>
                        <para>Open your <filename>php.ini</filename> file for editing</para>
                    </listitem>
                    <listitem>
                        <para>Add line
                                <code>zend_extension_ts=c:\full\path\to\phpexpress-php-x.x.dll</code>
                            if you are deploying on Windows, or
                                <code>zend_extension=/full/path/to/phpexpress-php-x.x</code>.so if
                            you are deploying on Unix, Linux or Mac OS operating systems</para>
                    </listitem>
                    <listitem>
                        <para>Copy <filename>phpexpress-php-x.x.dll</filename> or
                                <filename>phpexpress-php-x.x</filename>.so in the PHP extensions
                            directory specified in <filename>php.ini</filename> file.</para>
                    </listitem>
                    <listitem>
                        <para>Stop and Start Apache if you are running PHP as Apache module.</para>
                    </listitem>
                    <listitem>
                        <para>[Optional] Execute call to <code>phpinfo()</code> function and make
                            sure that PhpExpress is properly installed Once PhpExpress is installed
                            on the server, you can execute PHP Scripts encoded with Nu-Coder as well
                            as regular, not encoded PHP scripts. In both cases you will gain an
                            improved performance in the execution of the scripts.</para>
                    </listitem>
                </orderedlist>
            </para>
            <para> </para>
        </sect1>
    </chapter>
</part>
